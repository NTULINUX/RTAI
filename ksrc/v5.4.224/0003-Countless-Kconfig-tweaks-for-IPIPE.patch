From 851459cd92a1ceb90ad13a13e0cfa7c67146c5c7 Mon Sep 17 00:00:00 2001
From: Alec Ari <neotheuser@ymail.com>
Date: Wed, 16 Nov 2022 01:26:56 -0600
Subject: Countless Kconfig tweaks for IPIPE

Disables every problematic option I can think of and enables
several very important options for debugging, or those required
for base RTAI functionality. RTAI may cause kernel panics
so it is a good idea to always have these debugging features on.
The options enabled do not cause an increase in overhead.

Various other fixes and optimizations are included as well,
including CONFIG_DEBUG_FORCE_FUNCTION_ALIGN_64B

DRM drivers (including those that depend on WMI such as
Intel and Nouveau) are now re-enabled. If you experience
long latency delays, it is highly recommended to disable
these drivers as a troubleshooting step.

Signed-off-by: Alec Ari <neotheuser@ymail.com>
---
 Makefile                             |   4 +
 arch/Kconfig                         |   2 +-
 arch/x86/Kconfig                     | 142 +++++++++++++++------------
 arch/x86/Kconfig.debug               |  15 ++-
 arch/x86/events/Kconfig              |   1 +
 arch/x86/kvm/Kconfig                 |   1 +
 certs/Kconfig                        |   1 +
 drivers/acpi/Kconfig                 |  23 +++--
 drivers/acpi/dptf/Kconfig            |   2 +-
 drivers/ata/Kconfig                  |   3 +-
 drivers/bus/Kconfig                  |   1 +
 drivers/char/ipmi/Kconfig            |   2 +-
 drivers/char/tpm/Kconfig             |   2 +-
 drivers/clk/Kconfig                  |   2 +-
 drivers/clocksource/Kconfig          |  22 ++---
 drivers/cpufreq/Kconfig              |   1 +
 drivers/cpuidle/Kconfig              |   1 +
 drivers/crypto/Kconfig               |   1 +
 drivers/devfreq/Kconfig              |   1 +
 drivers/dma/Kconfig                  |   2 +-
 drivers/firmware/tegra/Kconfig       |   1 +
 drivers/gpu/drm/i915/Kconfig         |   2 +
 drivers/gpu/drm/nouveau/Kconfig      |  12 ++-
 drivers/hv/Kconfig                   |   1 +
 drivers/hwspinlock/Kconfig           |   1 +
 drivers/i2c/Kconfig                  |   2 +-
 drivers/iommu/Kconfig                |   2 +-
 drivers/mailbox/Kconfig              |   1 +
 drivers/md/Kconfig                   |   2 +-
 drivers/memory/Kconfig               |   1 +
 drivers/mfd/Kconfig                  |   3 +-
 drivers/net/ethernet/stmicro/Kconfig |   2 +-
 drivers/of/Kconfig                   |   1 +
 drivers/pci/Kconfig                  |   3 +
 drivers/pci/hotplug/Kconfig          |   2 +-
 drivers/pci/pcie/Kconfig             |   2 +-
 drivers/perf/Kconfig                 |   2 +-
 drivers/pinctrl/Kconfig              |   1 +
 drivers/platform/x86/Kconfig         |   2 +-
 drivers/power/avs/Kconfig            |   1 +
 drivers/power/reset/Kconfig          |   1 +
 drivers/powercap/Kconfig             |   1 +
 drivers/pwm/Kconfig                  |   1 +
 drivers/regulator/Kconfig            |   1 +
 drivers/remoteproc/Kconfig           |   1 +
 drivers/reset/Kconfig                |   1 +
 drivers/rpmsg/Kconfig                |   1 +
 drivers/scsi/ufs/Kconfig             |   2 +-
 drivers/sfi/Kconfig                  |   1 +
 drivers/soc/Kconfig                  |   1 +
 drivers/usb/chipidea/Kconfig         |   2 +-
 drivers/virt/Kconfig                 |   1 +
 drivers/virtio/Kconfig               |   1 +
 drivers/watchdog/Kconfig             |   1 +
 fs/Kconfig.binfmt                    |   1 +
 fs/verity/Kconfig                    |   1 +
 include/linux/ipipe.h                |   2 -
 init/Kconfig                         |  34 ++++---
 kernel/dma/Kconfig                   |   3 +-
 kernel/gcov/Kconfig                  |   1 +
 kernel/ipipe/Kconfig                 |  45 ++++++---
 kernel/ipipe/Kconfig.debug           |   6 --
 kernel/irq/Kconfig                   |   2 +-
 kernel/power/Kconfig                 |   3 +-
 kernel/trace/Kconfig                 |   1 +
 lib/Kconfig.debug                    |  43 +++++---
 lib/Kconfig.ubsan                    |   1 +
 lib/xz/Kconfig                       |   5 +
 mm/Kconfig                           |   6 +-
 mm/Kconfig.debug                     |   2 +
 net/wireless/Kconfig                 |   4 +-
 samples/Kconfig                      |   1 +
 security/Kconfig                     |   7 +-
 security/Kconfig.hardening           |   2 +
 sound/soc/Kconfig                    |   1 +
 75 files changed, 291 insertions(+), 169 deletions(-)

diff --git a/Makefile b/Makefile
index 3d46653e4..54df09d4b 100644
--- a/Makefile
+++ b/Makefile
@@ -866,6 +866,10 @@ ifdef CONFIG_LIVEPATCH
 KBUILD_CFLAGS += $(call cc-option, -flive-patching=inline-clone)
 endif
 
+ifdef CONFIG_DEBUG_FORCE_FUNCTION_ALIGN_64B
+KBUILD_CFLAGS += -falign-functions=64
+endif
+
 # arch Makefile may override CC so keep this after arch Makefile is included
 NOSTDINC_FLAGS += -nostdinc -isystem $(shell $(CC) -print-file-name=include)
 
diff --git a/arch/Kconfig b/arch/Kconfig
index 2219a07dc..0705c5ce6 100644
--- a/arch/Kconfig
+++ b/arch/Kconfig
@@ -524,7 +524,7 @@ config STACKPROTECTOR
 
 config STACKPROTECTOR_STRONG
 	bool "Strong Stack Protector"
-	depends on STACKPROTECTOR
+	depends on STACKPROTECTOR && !IPIPE
 	depends on $(cc-option,-fstack-protector-strong)
 	default y
 	help
diff --git a/arch/x86/Kconfig b/arch/x86/Kconfig
index 52719931e..bbb6a4797 100644
--- a/arch/x86/Kconfig
+++ b/arch/x86/Kconfig
@@ -60,17 +60,17 @@ config X86
 	select ARCH_CLOCKSOURCE_DATA
 	select ARCH_CLOCKSOURCE_INIT
 	select ARCH_HAS_ACPI_TABLE_UPGRADE	if ACPI
-	select ARCH_HAS_DEBUG_VIRTUAL
+	select ARCH_HAS_DEBUG_VIRTUAL		if !IPIPE
 	select ARCH_HAS_DEVMEM_IS_ALLOWED
 	select ARCH_HAS_ELF_RANDOMIZE
 	select ARCH_HAS_FAST_MULTIPLIER
 	select ARCH_HAS_FILTER_PGPROT
 	select ARCH_HAS_FORTIFY_SOURCE
-	select ARCH_HAS_GCOV_PROFILE_ALL
-	select ARCH_HAS_KCOV			if X86_64
+	select ARCH_HAS_GCOV_PROFILE_ALL	if !IPIPE
+	select ARCH_HAS_KCOV			if X86_64 && !IPIPE
 	select ARCH_HAS_MEM_ENCRYPT
 	select ARCH_HAS_MEMBARRIER_SYNC_CORE
-	select ARCH_HAS_PMEM_API		if X86_64
+	select ARCH_HAS_PMEM_API		if X86_64 && !IPIPE
 	select ARCH_HAS_PTE_DEVMAP		if X86_64
 	select ARCH_HAS_PTE_SPECIAL
 	select ARCH_HAS_UACCESS_FLUSHCACHE	if X86_64
@@ -80,7 +80,7 @@ config X86
 	select ARCH_HAS_STRICT_KERNEL_RWX
 	select ARCH_HAS_STRICT_MODULE_RWX
 	select ARCH_HAS_SYNC_CORE_BEFORE_USERMODE
-	select ARCH_HAS_UBSAN_SANITIZE_ALL
+	select ARCH_HAS_UBSAN_SANITIZE_ALL	if !IPIPE
 	select ARCH_HAVE_NMI_SAFE_CMPXCHG
 	select ARCH_MIGHT_HAVE_ACPI_PDC		if ACPI
 	select ARCH_MIGHT_HAVE_PC_PARPORT
@@ -88,7 +88,7 @@ config X86
 	select ARCH_STACKWALK
 	select ARCH_SUPPORTS_ACPI
 	select ARCH_SUPPORTS_ATOMIC_RMW
-	select ARCH_SUPPORTS_NUMA_BALANCING	if X86_64
+	select ARCH_SUPPORTS_NUMA_BALANCING	if X86_64 && !IPIPE
 	select ARCH_USE_BUILTIN_BSWAP
 	select ARCH_USE_QUEUED_RWLOCKS
 	select ARCH_USE_QUEUED_SPINLOCKS
@@ -101,14 +101,14 @@ config X86
 	select CLOCKSOURCE_VALIDATE_LAST_CYCLE
 	select CLOCKSOURCE_WATCHDOG
 	select DCACHE_WORD_ACCESS
-	select EDAC_ATOMIC_SCRUB
-	select EDAC_SUPPORT
+	select EDAC_ATOMIC_SCRUB		if !IPIPE
+	select EDAC_SUPPORT			if !IPIPE
 	select GENERIC_CLOCKEVENTS
 	select GENERIC_CLOCKEVENTS_BROADCAST	if X86_64 || (X86_32 && X86_LOCAL_APIC)
 	select GENERIC_CLOCKEVENTS_MIN_ADJUST
 	select GENERIC_CMOS_UPDATE
 	select GENERIC_CPU_AUTOPROBE
-	select GENERIC_CPU_VULNERABILITIES
+	select GENERIC_CPU_VULNERABILITIES	if !IPIPE
 	select GENERIC_EARLY_IOREMAP
 	select GENERIC_FIND_FIRST_BIT
 	select GENERIC_IOMAP
@@ -125,16 +125,16 @@ config X86
 	select GENERIC_TIME_VSYSCALL
 	select GENERIC_GETTIMEOFDAY
 	select GUP_GET_PTE_LOW_HIGH		if X86_PAE
-	select HARDLOCKUP_CHECK_TIMESTAMP	if X86_64
-	select HAVE_ACPI_APEI			if ACPI
-	select HAVE_ACPI_APEI_NMI		if ACPI
+	select HARDLOCKUP_CHECK_TIMESTAMP	if X86_64 && !IPIPE
+	select HAVE_ACPI_APEI			if ACPI && !IPIPE
+	select HAVE_ACPI_APEI_NMI		if ACPI && !IPIPE
 	select HAVE_ALIGNED_STRUCT_PAGE		if SLUB
-	select HAVE_ARCH_AUDITSYSCALL
+	select HAVE_ARCH_AUDITSYSCALL		if !IPIPE
 	select HAVE_ARCH_HUGE_VMAP		if X86_64 || X86_PAE
 	select HAVE_ARCH_JUMP_LABEL		if !IPIPE
 	select HAVE_ARCH_JUMP_LABEL_RELATIVE	if !IPIPE
-	select HAVE_ARCH_KASAN			if X86_64
-	select HAVE_ARCH_KGDB
+	select HAVE_ARCH_KASAN			if X86_64 && !IPIPE
+	select HAVE_ARCH_KGDB	 		if !IPIPE
 	select HAVE_ARCH_MMAP_RND_BITS		if MMU
 	select HAVE_ARCH_MMAP_RND_COMPAT_BITS	if MMU && COMPAT
 	select HAVE_ARCH_COMPAT_MMAP_BASES	if MMU && COMPAT
@@ -153,53 +153,48 @@ config X86
 	select HAVE_CONTEXT_TRACKING		if X86_64 && !IPIPE
 	select HAVE_COPY_THREAD_TLS
 	select HAVE_C_RECORDMCOUNT
-	select HAVE_DEBUG_KMEMLEAK
+	select HAVE_DEBUG_KMEMLEAK		if !IPIPE
 	select HAVE_DMA_CONTIGUOUS
-	select HAVE_DYNAMIC_FTRACE
-	select HAVE_DYNAMIC_FTRACE_WITH_REGS
+	select HAVE_DYNAMIC_FTRACE		if !IPIPE
+	select HAVE_DYNAMIC_FTRACE_WITH_REGS	if !IPIPE
 	select HAVE_EBPF_JIT
 	select HAVE_EFFICIENT_UNALIGNED_ACCESS
 	select HAVE_EISA
 	select HAVE_EXIT_THREAD
 	select HAVE_FAST_GUP
 	select HAVE_FENTRY			if X86_64 || DYNAMIC_FTRACE
-	select HAVE_FTRACE_MCOUNT_RECORD
-	select HAVE_FUNCTION_GRAPH_TRACER
-	select HAVE_FUNCTION_TRACER
-	select HAVE_GCC_PLUGINS
+	select HAVE_FTRACE_MCOUNT_RECORD	if !IPIPE
+	select HAVE_FUNCTION_GRAPH_TRACER	if !IPIPE
+	select HAVE_FUNCTION_TRACER		if !IPIPE
+	select HAVE_GCC_PLUGINS			if !IPIPE
 	select HAVE_HW_BREAKPOINT
 	select HAVE_IDE
 	select HAVE_IOREMAP_PROT
 	select HAVE_IRQ_EXIT_ON_IRQ_STACK	if X86_64
 	select HAVE_IRQ_TIME_ACCOUNTING
-	select HAVE_IPIPE_SUPPORT		if X86_64
 	select HAVE_IPIPE_TRACER_SUPPORT
-	select IPIPE_HAVE_HOSTRT if IPIPE
-	select IPIPE_HAVE_SAFE_THREAD_INFO if IPIPE
-	select IPIPE_WANT_PTE_PINNING if IPIPE
-	select IPIPE_HAVE_VM_NOTIFIER if IPIPE
 	select HAVE_KERNEL_BZIP2
 	select HAVE_KERNEL_GZIP
 	select HAVE_KERNEL_LZ4
 	select HAVE_KERNEL_LZMA
 	select HAVE_KERNEL_LZO
 	select HAVE_KERNEL_XZ
-	select HAVE_KPROBES
-	select HAVE_KPROBES_ON_FTRACE
-	select HAVE_FUNCTION_ERROR_INJECTION
-	select HAVE_KRETPROBES
-	select HAVE_KVM
-	select HAVE_LIVEPATCH			if X86_64
+	select HAVE_KPROBES			if !IPIPE
+	select HAVE_KPROBES_ON_FTRACE		if !IPIPE
+	select HAVE_FUNCTION_ERROR_INJECTION	if !IPIPE
+	select HAVE_KRETPROBES			if !IPIPE
+	select HAVE_KVM				if !IPIPE
+	select HAVE_LIVEPATCH			if X86_64 && !IPIPE
 	select HAVE_MEMBLOCK_NODE_MAP
 	select HAVE_MIXED_BREAKPOINTS_REGS
 	select HAVE_MOD_ARCH_SPECIFIC
 	select HAVE_MOVE_PMD
 	select HAVE_NMI
-	select HAVE_OPROFILE
+	select HAVE_OPROFILE			if !IPIPE
 	select HAVE_OPTPROBES
-	select HAVE_PCSPKR_PLATFORM
+	select HAVE_PCSPKR_PLATFORM		if !IPIPE
 	select HAVE_PERF_EVENTS
-	select HAVE_PERF_EVENTS_NMI
+	select HAVE_PERF_EVENTS_NMI		if !IPIPE
 	select HAVE_HARDLOCKUP_DETECTOR_PERF	if PERF_EVENTS && HAVE_PERF_EVENTS_NMI
 	select HAVE_PCI
 	select HAVE_PERF_REGS
@@ -209,13 +204,16 @@ config X86
 	select HAVE_RELIABLE_STACKTRACE		if X86_64 && (UNWINDER_FRAME_POINTER || UNWINDER_ORC) && STACK_VALIDATION
 	select HAVE_FUNCTION_ARG_ACCESS_API
 	select HAVE_STACKPROTECTOR		if CC_HAS_SANE_STACKPROTECTOR
-	select HAVE_STACK_VALIDATION		if X86_64
+	select HAVE_STACK_VALIDATION		if X86_64 && !IPIPE
 	select HAVE_RSEQ
 	select HAVE_SYSCALL_TRACEPOINTS
 	select HAVE_UNSTABLE_SCHED_CLOCK
 	select HAVE_USER_RETURN_NOTIFIER
 	select HAVE_GENERIC_VDSO
-	select HOTPLUG_SMT			if SMP
+	select HOTPLUG_SMT			if SMP && !IPIPE
+	select IPIPE
+	select IPIPE_HAVE_HOSTRT if IPIPE
+	select IPIPE_WANT_PTE_PINNING if IPIPE
 	select IRQ_FORCED_THREADING
 	select NEED_SG_DMA_LENGTH
 	select PCI_DOMAINS			if PCI
@@ -437,7 +435,7 @@ config X86_X2APIC
 config X86_MPPARSE
 	bool "Enable MPS table" if ACPI || SFI
 	default y
-	depends on X86_LOCAL_APIC
+	depends on X86_LOCAL_APIC && !IPIPE
 	---help---
 	  For old smp systems that do not have proper acpi support. Newer systems
 	  (esp with 64bit cpus) with acpi support, MADT and DSDT will override it
@@ -449,6 +447,7 @@ config GOLDFISH
 config RETPOLINE
 	bool "Avoid speculative indirect branches in kernel"
 	default y
+	depends on !IPIPE
 	select STACK_VALIDATION if HAVE_STACK_VALIDATION
 	help
 	  Compile kernel with the retpoline compiler options to guard against
@@ -458,7 +457,7 @@ config RETPOLINE
 
 config X86_CPU_RESCTRL
 	bool "x86 CPU resource control support"
-	depends on X86 && (CPU_SUP_INTEL || CPU_SUP_AMD)
+	depends on X86 && (CPU_SUP_INTEL || CPU_SUP_AMD) && !IPIPE
 	select KERNFS
 	help
 	  Enable x86 CPU resource control support.
@@ -507,6 +506,7 @@ endif
 if X86_64
 config X86_EXTENDED_PLATFORM
 	bool "Support for extended (non-PC) x86 platforms"
+	depends on !IPIPE
 	default y
 	---help---
 	  If you disable this option then the kernel will only support
@@ -629,7 +629,7 @@ config X86_INTEL_QUARK
 
 config X86_INTEL_LPSS
 	bool "Intel Low Power Subsystem Support"
-	depends on X86 && ACPI && PCI
+	depends on X86 && ACPI && PCI && !IPIPE
 	select COMMON_CLK
 	select PINCTRL
 	select IOSF_MBI
@@ -641,7 +641,7 @@ config X86_INTEL_LPSS
 
 config X86_AMD_PLATFORM_DEVICE
 	bool "AMD ACPI2Platform devices support"
-	depends on ACPI
+	depends on ACPI && !IPIPE
 	select COMMON_CLK
 	select PINCTRL
 	---help---
@@ -753,6 +753,7 @@ config SCHED_OMIT_FRAME_POINTER
 
 menuconfig HYPERVISOR_GUEST
 	bool "Linux guest support"
+	depends on !IPIPE
 	---help---
 	  Say Y here to enable options for running Linux under various hyper-
 	  visors. This option enables basic hypervisor detection and platform
@@ -765,7 +766,6 @@ if HYPERVISOR_GUEST
 
 config PARAVIRT
 	bool "Enable paravirtualization code"
-	depends on !IPIPE
 	---help---
 	  This changes the kernel so it can modify itself when it is run
 	  under a hypervisor, potentially improving performance significantly
@@ -922,7 +922,7 @@ config GART_IOMMU
 	bool "Old AMD GART IOMMU support"
 	select IOMMU_HELPER
 	select SWIOTLB
-	depends on X86_64 && PCI && AMD_NB
+	depends on X86_64 && PCI && AMD_NB && !IPIPE
 	---help---
 	  Provides a driver for older AMD Athlon64/Opteron/Turion/Sempron
 	  GART based hardware IOMMUs.
@@ -944,7 +944,7 @@ config CALGARY_IOMMU
 	bool "IBM Calgary IOMMU support"
 	select IOMMU_HELPER
 	select SWIOTLB
-	depends on X86_64 && PCI
+	depends on X86_64 && PCI && !IPIPE
 	---help---
 	  Support for hardware IOMMUs in IBM's xSeries x366 and x460
 	  systems. Needed to run systems with more than 3GB of memory
@@ -1008,8 +1008,9 @@ config NR_CPUS_RANGE_END
 config NR_CPUS_RANGE_END
 	int
 	depends on X86_64
-	default 8192 if  SMP && ( MAXSMP ||  CPUMASK_OFFSTACK)
-	default  512 if  SMP && (!MAXSMP && !CPUMASK_OFFSTACK)
+	default 8192 if  SMP && ( MAXSMP ||  CPUMASK_OFFSTACK) && !IPIPE
+	default  512 if  SMP && (!MAXSMP && !CPUMASK_OFFSTACK) && !IPIPE
+	default   32 if  SMP && IPIPE
 	default    1 if !SMP
 
 config NR_CPUS_DEFAULT
@@ -1024,6 +1025,7 @@ config NR_CPUS_DEFAULT
 	depends on X86_64
 	default 8192 if  MAXSMP
 	default   64 if  SMP
+	default    8 if  IPIPE
 	default    1 if !SMP
 
 config NR_CPUS
@@ -1036,16 +1038,19 @@ config NR_CPUS
 	  supported value is 8192, otherwise the maximum value is 512.  The
 	  minimum value which makes sense is 2.
 
-	  This is purely to save memory: each supported CPU adds about 8KB
-	  to the kernel image.
+	  For IPIPE-enabled platforms, large values causes serious problems.
+	  The max limit in this case is 16.
+
+	  Each supported CPU adds approximately 8KB to the kernel image.
 
 config SCHED_SMT
 	def_bool y if SMP
+	depends on !IPIPE
 
 config SCHED_MC
 	def_bool y
 	prompt "Multi-core scheduler support"
-	depends on SMP
+	depends on SMP && !IPIPE
 	---help---
 	  Multi-core scheduler support improves the CPU scheduler's decision
 	  making when dealing with multi-core CPU chips at a cost of slightly
@@ -1139,6 +1144,7 @@ config X86_REROUTE_FOR_BROKEN_BOOT_IRQS
 
 config X86_MCE
 	bool "Machine Check / overheating reporting"
+	depends on !IPIPE
 	select GENERIC_ALLOCATOR
 	default y
 	---help---
@@ -1249,7 +1255,7 @@ config X86_ESPFIX64
 config X86_VSYSCALL_EMULATION
        bool "Enable vsyscall emulation" if EXPERT
        default y
-       depends on X86_64
+       depends on X86_64 && !IPIPE
        ---help---
 	 This enables emulation of the legacy vsyscall page.  Disabling
 	 it is roughly equivalent to booting with vsyscall=none, except
@@ -1282,6 +1288,7 @@ config TOSHIBA
 
 config I8K
 	tristate "Dell i8k legacy laptop support"
+	depends on !IPIPE
 	select HWMON
 	select SENSORS_DELL_SMM
 	---help---
@@ -1359,7 +1366,7 @@ config MICROCODE_AMD
 config MICROCODE_OLD_INTERFACE
 	bool "Ancient loading interface (DEPRECATED)"
 	default n
-	depends on MICROCODE
+	depends on MICROCODE && !IPIPE
 	---help---
 	  DO NOT USE THIS! This is the ancient /dev/cpu/microcode interface
 	  which was used by userspace tools like iucode_tool and microcode.ctl.
@@ -1504,7 +1511,7 @@ config X86_5LEVEL
 	bool "Enable 5-level page tables support"
 	select DYNAMIC_MEMORY_LAYOUT
 	select SPARSEMEM_VMEMMAP
-	depends on X86_64
+	depends on X86_64 && !IPIPE
 	---help---
 	  5-level paging enables access to larger address space:
 	  upto 128 PiB of virtual address space and 4 PiB of
@@ -1531,7 +1538,7 @@ config X86_DIRECT_GBPAGES
 
 config X86_CPA_STATISTICS
 	bool "Enable statistic for Change Page Attribute"
-	depends on DEBUG_FS
+	depends on DEBUG_FS && !IPIPE
 	---help---
 	  Expose statistics about the Change Page Attribute mechanims, which
 	  helps to determine the effectiveness of preserving large and huge
@@ -1539,7 +1546,7 @@ config X86_CPA_STATISTICS
 
 config AMD_MEM_ENCRYPT
 	bool "AMD Secure Memory Encryption (SME) support"
-	depends on X86_64 && CPU_SUP_AMD
+	depends on X86_64 && CPU_SUP_AMD && !IPIPE
 	select DYNAMIC_PHYSICAL_MASK
 	select ARCH_USE_MEMREMAP_PROT
 	select ARCH_HAS_FORCE_DMA_UNENCRYPTED
@@ -1566,6 +1573,7 @@ config NUMA
 	bool "Numa Memory Allocation and Scheduler Support"
 	depends on SMP
 	depends on X86_64 || (X86_32 && HIGHMEM64G && X86_BIGSMP)
+	depends on !IPIPE
 	default y if X86_BIGSMP
 	---help---
 	  Enable NUMA (Non Uniform Memory Access) support.
@@ -1677,8 +1685,7 @@ config X86_PMEM_LEGACY_DEVICE
 
 config X86_PMEM_LEGACY
 	tristate "Support non-standard NVDIMMs and ADR protected memory"
-	depends on PHYS_ADDR_T_64BIT
-	depends on BLK_DEV
+	depends on PHYS_ADDR_T_64BIT && BLK_DEV && !IPIPE
 	select X86_PMEM_LEGACY_DEVICE
 	select LIBNVDIMM
 	help
@@ -1880,6 +1887,7 @@ config ARCH_RANDOM
 
 config X86_SMAP
 	def_bool y
+	depends on !IPIPE
 	prompt "Supervisor Mode Access Prevention" if EXPERT
 	---help---
 	  Supervisor Mode Access Prevention (SMAP) is a security
@@ -1891,7 +1899,7 @@ config X86_SMAP
 
 config X86_INTEL_UMIP
 	def_bool y
-	depends on CPU_SUP_INTEL
+	depends on CPU_SUP_INTEL && !IPIPE
 	prompt "Intel User Mode Instruction Prevention" if EXPERT
 	---help---
 	  The User Mode Instruction Prevention (UMIP) is a security
@@ -1909,7 +1917,7 @@ config X86_INTEL_MPX
 	prompt "Intel MPX (Memory Protection Extensions)"
 	def_bool n
 	# Note: only available in 64-bit mode due to VMA flags shortage
-	depends on CPU_SUP_INTEL && X86_64
+	depends on CPU_SUP_INTEL && X86_64 && !IPIPE
 	select ARCH_USES_HIGH_VMA_FLAGS
 	---help---
 	  MPX provides hardware features that can be used in
@@ -1937,7 +1945,7 @@ config X86_INTEL_MEMORY_PROTECTION_KEYS
 	prompt "Intel Memory Protection Keys"
 	def_bool y
 	# Note: only available in 64-bit mode
-	depends on CPU_SUP_INTEL && X86_64
+	depends on CPU_SUP_INTEL && X86_64 && !IPIPE
 	select ARCH_USES_HIGH_VMA_FLAGS
 	select ARCH_HAS_PKEYS
 	---help---
@@ -1996,7 +2004,7 @@ endchoice
 
 config EFI
 	bool "EFI runtime service support"
-	depends on ACPI
+	depends on ACPI && !IPIPE
 	select UCS2_STRING
 	select EFI_RUNTIME_WRAPPERS
 	select ARCH_USE_MEMREMAP_PROT
@@ -2055,6 +2063,7 @@ source "kernel/Kconfig.hz"
 
 config KEXEC
 	bool "kexec system call"
+	depends on !IPIPE
 	select KEXEC_CORE
 	---help---
 	  kexec is a system call that implements the ability to shutdown your
@@ -2077,6 +2086,7 @@ config KEXEC_FILE
 	depends on X86_64
 	depends on CRYPTO=y
 	depends on CRYPTO_SHA256=y
+	depends on !IPIPE
 	---help---
 	  This is new version of kexec system call. This system call is
 	  file based and takes file descriptors as system call argument
@@ -2118,6 +2128,7 @@ config KEXEC_BZIMAGE_VERIFY_SIG
 config CRASH_DUMP
 	bool "kernel crash dumps"
 	depends on X86_64 || (X86_32 && HIGHMEM)
+	depends on !IPIPE
 	---help---
 	  Generate crash dump after being started by kexec.
 	  This should be normally only set in special crash dump kernels
@@ -2179,6 +2190,7 @@ config PHYSICAL_START
 
 config RELOCATABLE
 	bool "Build a relocatable kernel"
+	depends on !IPIPE
 	default y
 	---help---
 	  This builds a kernel image that retains relocation information
@@ -2302,7 +2314,7 @@ config RANDOMIZE_MEMORY_PHYSICAL_PADDING
 
 config HOTPLUG_CPU
 	def_bool y
-	depends on SMP
+	depends on SMP && !IPIPE
 
 config BOOTPARAM_HOTPLUG_CPU0
 	bool "Set default setting of cpu0_hotpluggable"
@@ -2375,7 +2387,7 @@ config COMPAT_VDSO
 choice
 	prompt "vsyscall table for legacy applications"
 	depends on X86_64
-	default LEGACY_VSYSCALL_XONLY
+	default LEGACY_VSYSCALL_NONE
 	help
 	  Legacy user code that does not know how to find the vDSO expects
 	  to be able to issue three syscalls by calling fixed addresses in
@@ -2393,6 +2405,7 @@ choice
 
 	config LEGACY_VSYSCALL_EMULATE
 		bool "Full emulation"
+		depends on !IPIPE
 		help
 		  The kernel traps and emulates calls into the fixed vsyscall
 		  address mapping. This makes the mapping non-executable, but
@@ -2407,6 +2420,7 @@ choice
 
 	config LEGACY_VSYSCALL_XONLY
 		bool "Emulate execution only"
+		depends on !IPIPE
 		help
 		  The kernel traps and emulates calls into the fixed vsyscall
 		  address mapping and does not allow reads.  This
@@ -2472,6 +2486,7 @@ config CMDLINE_OVERRIDE
 
 config MODIFY_LDT_SYSCALL
 	bool "Enable the LDT (local descriptor table)" if EXPERT
+	depends on !IPIPE
 	default y
 	---help---
 	  Linux can allow user programs to install a per-process x86
@@ -2917,6 +2932,7 @@ endmenu
 
 
 menu "Binary Emulations"
+	depends on !IPIPE
 
 config IA32_EMULATION
 	bool "IA32 Emulation"
diff --git a/arch/x86/Kconfig.debug b/arch/x86/Kconfig.debug
index bf9cd83de..b8176d082 100644
--- a/arch/x86/Kconfig.debug
+++ b/arch/x86/Kconfig.debug
@@ -181,10 +181,10 @@ config X86_DECODER_SELFTEST
 
 choice
 	prompt "IO delay type"
-	default IO_DELAY_0X80
+	default IO_DELAY_NONE
 
 config IO_DELAY_0X80
-	bool "port 0x80 based port-IO delay [recommended]"
+	bool "port 0x80 based port-IO delay"
 	---help---
 	  This is the traditional Linux IO delay used for in/out_p.
 	  It is the most tested hence safest selection here.
@@ -202,7 +202,7 @@ config IO_DELAY_UDELAY
 	  while not having any side-effect on the IO port space.
 
 config IO_DELAY_NONE
-	bool "no port-IO delay"
+	bool "no port-IO delay [recommended]"
 	---help---
 	  No port-IO delay. Will break on old boxes that require port-IO
 	  delay for certain operations. Should work on most new machines.
@@ -270,7 +270,7 @@ config X86_DEBUG_FPU
 
 config PUNIT_ATOM_DEBUG
 	tristate "ATOM Punit debug driver"
-	depends on PCI
+	depends on PCI && !IPIPE
 	select DEBUG_FS
 	select IOSF_MBI
 	---help---
@@ -282,8 +282,7 @@ config PUNIT_ATOM_DEBUG
 
 choice
 	prompt "Choose kernel unwinder"
-	default UNWINDER_ORC if X86_64
-	default UNWINDER_FRAME_POINTER if X86_32
+	default UNWINDER_GUESS
 	---help---
 	  This determines which method will be used for unwinding kernel stack
 	  traces for panics, oopses, bugs, warnings, perf, /proc/<pid>/stack,
@@ -291,7 +290,7 @@ choice
 
 config UNWINDER_ORC
 	bool "ORC unwinder"
-	depends on X86_64
+	depends on X86_64 && !IPIPE
 	select STACK_VALIDATION
 	---help---
 	  This option enables the ORC (Oops Rewind Capability) unwinder for
@@ -307,6 +306,7 @@ config UNWINDER_ORC
 
 config UNWINDER_FRAME_POINTER
 	bool "Frame pointer unwinder"
+	depends on !IPIPE
 	select FRAME_POINTER
 	---help---
 	  This option enables the frame pointer unwinder for unwinding kernel
@@ -322,7 +322,6 @@ config UNWINDER_FRAME_POINTER
 
 config UNWINDER_GUESS
 	bool "Guess unwinder"
-	depends on EXPERT
 	depends on !STACKDEPOT
 	---help---
 	  This option enables the "guess" unwinder for unwinding kernel stack
diff --git a/arch/x86/events/Kconfig b/arch/x86/events/Kconfig
index 4a809c6cb..ad28cdb04 100644
--- a/arch/x86/events/Kconfig
+++ b/arch/x86/events/Kconfig
@@ -1,5 +1,6 @@
 # SPDX-License-Identifier: GPL-2.0
 menu "Performance monitoring"
+	depends on !IPIPE
 
 config PERF_EVENTS_INTEL_UNCORE
 	tristate "Intel uncore performance events"
diff --git a/arch/x86/kvm/Kconfig b/arch/x86/kvm/Kconfig
index 840e12583..3629546e7 100644
--- a/arch/x86/kvm/Kconfig
+++ b/arch/x86/kvm/Kconfig
@@ -8,6 +8,7 @@ source "virt/kvm/Kconfig"
 menuconfig VIRTUALIZATION
 	bool "Virtualization"
 	depends on HAVE_KVM || X86
+	depends on !IPIPE
 	default y
 	---help---
 	  Say Y here to get to see options for using your Linux host to run other
diff --git a/certs/Kconfig b/certs/Kconfig
index 76e469b56..cfea091ac 100644
--- a/certs/Kconfig
+++ b/certs/Kconfig
@@ -1,5 +1,6 @@
 # SPDX-License-Identifier: GPL-2.0
 menu "Certificates for signature checking"
+depends on !IPIPE
 
 config MODULE_SIG_KEY
 	string "File name or PKCS#11 URI of module signing key"
diff --git a/drivers/acpi/Kconfig b/drivers/acpi/Kconfig
index ebe1e9e5f..505942eed 100644
--- a/drivers/acpi/Kconfig
+++ b/drivers/acpi/Kconfig
@@ -62,6 +62,7 @@ config ACPI_CCA_REQUIRED
 
 config ACPI_DEBUGGER
 	bool "AML debugger interface"
+	depends on !IPIPE
 	select ACPI_DEBUG
 	help
 	  Enable in-kernel debugging of AML facilities: statistics,
@@ -82,6 +83,7 @@ endif
 
 config ACPI_SPCR_TABLE
 	bool "ACPI Serial Port Console Redirection Support"
+	depends on !IPIPE
 	default y if X86
 	help
 	  Enable support for Serial Port Console Redirection (SPCR) Table.
@@ -138,6 +140,7 @@ config ACPI_REV_OVERRIDE_POSSIBLE
 
 config ACPI_EC_DEBUGFS
 	tristate "EC read/write access through /sys/kernel/debug/ec"
+	depends on !IPIPE
 	help
 	  Say N to disable Embedded Controller /sys/kernel/debug interface
 
@@ -155,6 +158,7 @@ config ACPI_EC_DEBUGFS
 
 config ACPI_AC
 	tristate "AC Adapter"
+	depends on !IPIPE
 	select POWER_SUPPLY
 	default y
 	help
@@ -167,6 +171,7 @@ config ACPI_AC
 
 config ACPI_BATTERY
 	tristate "Battery"
+	depends on !IPIPE
 	select POWER_SUPPLY
 	default y
 	help
@@ -218,7 +223,7 @@ config ACPI_FAN
 
 config ACPI_TAD
 	tristate "ACPI Time and Alarm (TAD) Device Support"
-	depends on SYSFS && PM_SLEEP
+	depends on SYSFS && PM_SLEEP && !IPIPE
 	help
 	  The ACPI Time and Alarm (TAD) device is an alternative to the Real
 	  Time Clock (RTC).  Its wake timers allow the system to transition from
@@ -231,6 +236,7 @@ config ACPI_TAD
 
 config ACPI_DOCK
 	bool "Dock"
+	depends on !IPIPE
 	help
 	  This driver supports ACPI-controlled docking stations and removable
 	  drive bays such as the IBM Ultrabay and the Dell Module Bay.
@@ -241,7 +247,7 @@ config ACPI_CPU_FREQ_PSS
 
 config ACPI_PROCESSOR_CSTATE
 	def_bool y
-	depends on IA64 || X86
+	depends on IA64 || (X86 && !IPIPE)
 
 config ACPI_PROCESSOR_IDLE
 	bool
@@ -265,6 +271,7 @@ config ACPI_CPPC_LIB
 
 config ACPI_PROCESSOR
 	tristate "Processor"
+	depends on !IPIPE
 	depends on X86 || IA64 || ARM64
 	select ACPI_PROCESSOR_IDLE
 	select ACPI_CPU_FREQ_PSS if X86 || IA64
@@ -367,6 +374,7 @@ config ACPI_TABLE_OVERRIDE_VIA_BUILTIN_INITRD
 
 config ACPI_DEBUG
 	bool "Debug Statements"
+	depends on !IPIPE
 	help
 	  The ACPI subsystem can produce debug output.  Saying Y enables this
 	  output and increases the kernel size by around 50K.
@@ -378,7 +386,7 @@ config ACPI_DEBUG
 
 config ACPI_PCI_SLOT
 	bool "PCI slot detection driver"
-	depends on SYSFS && PCI
+	depends on SYSFS && PCI && !IPIPE
 	help
 	  This driver creates entries in /sys/bus/pci/slots/ for all PCI
 	  slots in the system.  This can help correlate PCI bus addresses,
@@ -387,7 +395,7 @@ config ACPI_PCI_SLOT
 
 config ACPI_CONTAINER
 	bool "Container and Module Devices"
-	default (ACPI_HOTPLUG_MEMORY || ACPI_HOTPLUG_CPU)
+	depends on (ACPI_HOTPLUG_MEMORY || ACPI_HOTPLUG_CPU)
 	help
 	  This driver supports ACPI Container and Module devices (IDs
 	  ACPI0004, PNP0A05, and PNP0A06).
@@ -421,7 +429,7 @@ config ACPI_HOTPLUG_IOAPIC
 
 config ACPI_SBS
 	tristate "Smart Battery System"
-	depends on X86
+	depends on X86 && !IPIPE
 	select POWER_SUPPLY
 	help
 	  This driver supports the Smart Battery System, another
@@ -432,6 +440,7 @@ config ACPI_SBS
 
 config ACPI_HED
 	tristate "Hardware Error Device"
+	depends on !IPIPE
 	help
 	  This driver supports the Hardware Error Device (PNP0C33),
 	  which is used to report some hardware errors notified via
@@ -439,7 +448,7 @@ config ACPI_HED
 
 config ACPI_CUSTOM_METHOD
 	tristate "Allow ACPI methods to be inserted/replaced at run time"
-	depends on DEBUG_FS
+	depends on DEBUG_FS && !IPIPE
 	help
 	  This debug facility allows ACPI AML methods to be inserted and/or
 	  replaced without rebooting the system. For details refer to:
@@ -506,6 +515,7 @@ config ACPI_ADXL
 
 menuconfig PMIC_OPREGION
 	bool "PMIC (Power Management Integrated Circuit) operation region support"
+	depends on !IPIPE
 	help
 	  Select this option to enable support for ACPI operation
 	  region of the PMIC chip. The operation region can be used
@@ -547,6 +557,7 @@ endif
 
 config ACPI_CONFIGFS
 	tristate "ACPI configfs support"
+	depends on !IPIPE
 	select CONFIGFS_FS
 	help
 	  Select this option to enable support for ACPI configuration from
diff --git a/drivers/acpi/dptf/Kconfig b/drivers/acpi/dptf/Kconfig
index 90a2fd979..bc4189889 100644
--- a/drivers/acpi/dptf/Kconfig
+++ b/drivers/acpi/dptf/Kconfig
@@ -1,7 +1,7 @@
 # SPDX-License-Identifier: GPL-2.0
 config DPTF_POWER
 	tristate "DPTF Platform Power Participant"
-	depends on X86
+	depends on X86 && !IPIPE
 	help
 	  This driver adds support for Dynamic Platform and Thermal Framework
 	  (DPTF) Platform Power Participant device (INT3407) support.
diff --git a/drivers/ata/Kconfig b/drivers/ata/Kconfig
index a6beb2c5a..e8e278fb0 100644
--- a/drivers/ata/Kconfig
+++ b/drivers/ata/Kconfig
@@ -92,7 +92,8 @@ config SATA_AHCI
 
 config SATA_MOBILE_LPM_POLICY
 	int "Default SATA Link Power Management policy for mobile chipsets"
-	range 0 4
+	range 0 4 if !IPIPE
+	range 1 1 if IPIPE
 	default 0
 	depends on SATA_AHCI
 	help
diff --git a/drivers/bus/Kconfig b/drivers/bus/Kconfig
index 47c2bb444..6162844be 100644
--- a/drivers/bus/Kconfig
+++ b/drivers/bus/Kconfig
@@ -4,6 +4,7 @@
 #
 
 menu "Bus devices"
+	depends on !IPIPE
 
 config ARM_CCI
 	bool
diff --git a/drivers/char/ipmi/Kconfig b/drivers/char/ipmi/Kconfig
index 4bad06141..2e407624e 100644
--- a/drivers/char/ipmi/Kconfig
+++ b/drivers/char/ipmi/Kconfig
@@ -5,7 +5,7 @@
 
 menuconfig IPMI_HANDLER
        tristate 'IPMI top-level message handler'
-       depends on HAS_IOMEM
+       depends on HAS_IOMEM && !IPIPE
        select IPMI_DMI_DECODE if DMI
        help
          This enables the central IPMI message handler, required for IPMI
diff --git a/drivers/char/tpm/Kconfig b/drivers/char/tpm/Kconfig
index 9c37047f4..b72370a6c 100644
--- a/drivers/char/tpm/Kconfig
+++ b/drivers/char/tpm/Kconfig
@@ -5,7 +5,7 @@
 
 menuconfig TCG_TPM
 	tristate "TPM Hardware Support"
-	depends on HAS_IOMEM
+	depends on HAS_IOMEM && !IPIPE
 	imply SECURITYFS
 	select CRYPTO
 	select CRYPTO_HASH_INFO
diff --git a/drivers/clk/Kconfig b/drivers/clk/Kconfig
index c44247d0b..2c0064438 100644
--- a/drivers/clk/Kconfig
+++ b/drivers/clk/Kconfig
@@ -21,7 +21,7 @@ config COMMON_CLK
 	  this option.
 
 menu "Common Clock Framework"
-	depends on COMMON_CLK
+	depends on COMMON_CLK && !IPIPE
 
 config COMMON_CLK_WM831X
 	tristate "Clock driver for WM831x/2x PMICs"
diff --git a/drivers/clocksource/Kconfig b/drivers/clocksource/Kconfig
index 9bfe4c5af..65e6f6e91 100644
--- a/drivers/clocksource/Kconfig
+++ b/drivers/clocksource/Kconfig
@@ -1,4 +1,14 @@
 # SPDX-License-Identifier: GPL-2.0-only
+
+config CLKEVT_I8253
+	bool
+
+config I8253_LOCK
+	bool
+
+config CLKBLD_I8253
+	def_bool y if CLKSRC_I8253 || CLKEVT_I8253 || I8253_LOCK
+
 menu "Clock Source drivers"
 	depends on GENERIC_CLOCKEVENTS
 
@@ -13,22 +23,10 @@ config TIMER_ACPI
 config TIMER_PROBE
 	bool
 
-config CLKSRC_I8253
-	bool
-
-config CLKEVT_I8253
-	bool
-
-config I8253_LOCK
-	bool
-
 config OMAP_DM_TIMER
 	bool
 	select TIMER_OF
 
-config CLKBLD_I8253
-	def_bool y if CLKSRC_I8253 || CLKEVT_I8253 || I8253_LOCK
-
 config CLKSRC_MMIO
 	bool
 
diff --git a/drivers/cpufreq/Kconfig b/drivers/cpufreq/Kconfig
index bff529501..39fcd34d0 100644
--- a/drivers/cpufreq/Kconfig
+++ b/drivers/cpufreq/Kconfig
@@ -1,5 +1,6 @@
 # SPDX-License-Identifier: GPL-2.0-only
 menu "CPU Frequency scaling"
+	depends on !IPIPE
 
 config CPU_FREQ
 	bool "CPU Frequency scaling"
diff --git a/drivers/cpuidle/Kconfig b/drivers/cpuidle/Kconfig
index 88727b7c0..332d5e65d 100644
--- a/drivers/cpuidle/Kconfig
+++ b/drivers/cpuidle/Kconfig
@@ -1,5 +1,6 @@
 # SPDX-License-Identifier: GPL-2.0-only
 menu "CPU Idle"
+	depends on !IPIPE
 
 config CPU_IDLE
 	bool "CPU idle PM support"
diff --git a/drivers/crypto/Kconfig b/drivers/crypto/Kconfig
index 1f6308cdf..87586854b 100644
--- a/drivers/crypto/Kconfig
+++ b/drivers/crypto/Kconfig
@@ -2,6 +2,7 @@
 
 menuconfig CRYPTO_HW
 	bool "Hardware crypto devices"
+	depends on !IPIPE
 	default y
 	---help---
 	  Say Y here to get to see options for hardware crypto devices and
diff --git a/drivers/devfreq/Kconfig b/drivers/devfreq/Kconfig
index 1433f2ba9..cbbb40cf7 100644
--- a/drivers/devfreq/Kconfig
+++ b/drivers/devfreq/Kconfig
@@ -1,6 +1,7 @@
 # SPDX-License-Identifier: GPL-2.0-only
 menuconfig PM_DEVFREQ
 	bool "Generic Dynamic Voltage and Frequency Scaling (DVFS) support"
+	depends on !IPIPE
 	select SRCU
 	select PM_OPP
 	help
diff --git a/drivers/dma/Kconfig b/drivers/dma/Kconfig
index 1322461f1..e7f3175ee 100644
--- a/drivers/dma/Kconfig
+++ b/drivers/dma/Kconfig
@@ -5,7 +5,7 @@
 
 menuconfig DMADEVICES
 	bool "DMA Engine support"
-	depends on HAS_DMA
+	depends on HAS_DMA && !IPIPE
 	help
 	  DMA engines can do asynchronous data transfers without
 	  involving the host CPU.  Currently, this framework can be
diff --git a/drivers/firmware/tegra/Kconfig b/drivers/firmware/tegra/Kconfig
index a887731f5..ba9ec55a8 100644
--- a/drivers/firmware/tegra/Kconfig
+++ b/drivers/firmware/tegra/Kconfig
@@ -1,5 +1,6 @@
 # SPDX-License-Identifier: GPL-2.0-only
 menu "Tegra firmware driver"
+	depends on !IPIPE
 
 config TEGRA_IVC
 	bool "Tegra IVC protocol"
diff --git a/drivers/gpu/drm/i915/Kconfig b/drivers/gpu/drm/i915/Kconfig
index 331779894..fc0294879 100644
--- a/drivers/gpu/drm/i915/Kconfig
+++ b/drivers/gpu/drm/i915/Kconfig
@@ -107,6 +107,7 @@ config DRM_I915_GVT
         bool "Enable Intel GVT-g graphics virtualization host support"
         depends on DRM_I915
         depends on 64BIT
+        depends on !IPIPE
         default n
         help
 	  Choose this option if you want to enable Intel GVT-g graphics
@@ -139,6 +140,7 @@ config DRM_I915_GVT_KVMGT
 menu "drm/i915 Debugging"
 depends on DRM_I915
 depends on EXPERT
+depends on !IPIPE
 source "drivers/gpu/drm/i915/Kconfig.debug"
 endmenu
 
diff --git a/drivers/gpu/drm/nouveau/Kconfig b/drivers/gpu/drm/nouveau/Kconfig
index 3558df043..bb970a3a3 100644
--- a/drivers/gpu/drm/nouveau/Kconfig
+++ b/drivers/gpu/drm/nouveau/Kconfig
@@ -42,14 +42,15 @@ config NOUVEAU_PLATFORM_DRIVER
 config NOUVEAU_DEBUG
 	int "Maximum debug level"
 	depends on DRM_NOUVEAU
-	range 0 7
-	default 5
+	range 0 7 if !IPIPE
+	range 0 2 if IPIPE
+	default 2
 	help
 	  Selects the maximum debug level to compile support for.
 
 	  0 - fatal
 	  1 - error
-	  2 - warning
+	  2 - warning (maximum if IPIPE enabled)
 	  3 - info
 	  4 - debug
 	  5 - trace (recommended)
@@ -62,8 +63,9 @@ config NOUVEAU_DEBUG
 config NOUVEAU_DEBUG_DEFAULT
 	int "Default debug level"
 	depends on DRM_NOUVEAU
-	range 0 7
-	default 3
+	range 0 7 if !IPIPE
+	range 0 2 if IPIPE
+	default 1
 	help
 	  Selects the default debug level
 
diff --git a/drivers/hv/Kconfig b/drivers/hv/Kconfig
index 79e5356a7..8b44d8b11 100644
--- a/drivers/hv/Kconfig
+++ b/drivers/hv/Kconfig
@@ -1,6 +1,7 @@
 # SPDX-License-Identifier: GPL-2.0
 
 menu "Microsoft Hyper-V guest support"
+	depends on !IPIPE
 
 config HYPERV
 	tristate "Microsoft Hyper-V client drivers"
diff --git a/drivers/hwspinlock/Kconfig b/drivers/hwspinlock/Kconfig
index 37740e992..bdbab3b66 100644
--- a/drivers/hwspinlock/Kconfig
+++ b/drivers/hwspinlock/Kconfig
@@ -5,6 +5,7 @@
 
 menuconfig HWSPINLOCK
 	bool "Hardware Spinlock drivers"
+	depends on !IPIPE
 
 config HWSPINLOCK_OMAP
 	tristate "OMAP Hardware Spinlock device"
diff --git a/drivers/i2c/Kconfig b/drivers/i2c/Kconfig
index 1474e57ec..0fa343930 100644
--- a/drivers/i2c/Kconfig
+++ b/drivers/i2c/Kconfig
@@ -27,7 +27,7 @@ config I2C
 
 config ACPI_I2C_OPREGION
 	bool "ACPI I2C Operation region support"
-	depends on I2C=y && ACPI
+	depends on I2C=y && ACPI && !IPIPE
 	default y
 	help
 	  Say Y here if you want to enable ACPI I2C operation region support.
diff --git a/drivers/iommu/Kconfig b/drivers/iommu/Kconfig
index fc0160e8e..bcc8f3f98 100644
--- a/drivers/iommu/Kconfig
+++ b/drivers/iommu/Kconfig
@@ -9,7 +9,7 @@ config IOMMU_API
 
 menuconfig IOMMU_SUPPORT
 	bool "IOMMU Hardware Support"
-	depends on MMU
+	depends on MMU && !IPIPE
 	default y
 	---help---
 	  Say Y here if you want to compile device drivers for IO Memory
diff --git a/drivers/mailbox/Kconfig b/drivers/mailbox/Kconfig
index ab4eb750b..8c481eb90 100644
--- a/drivers/mailbox/Kconfig
+++ b/drivers/mailbox/Kconfig
@@ -1,6 +1,7 @@
 # SPDX-License-Identifier: GPL-2.0-only
 menuconfig MAILBOX
 	bool "Mailbox Hardware Support"
+	depends on !IPIPE
 	help
 	  Mailbox is a framework to control hardware communication between
 	  on-chip processors through queued messages and interrupt driven
diff --git a/drivers/md/Kconfig b/drivers/md/Kconfig
index 7dd6e9825..7f9e52ef6 100644
--- a/drivers/md/Kconfig
+++ b/drivers/md/Kconfig
@@ -487,7 +487,7 @@ config DM_FLAKEY
 
 config DM_VERITY
 	tristate "Verity target support"
-	depends on BLK_DEV_DM
+	depends on BLK_DEV_DM && !IPIPE
 	select CRYPTO
 	select CRYPTO_HASH
 	select DM_BUFIO
diff --git a/drivers/memory/Kconfig b/drivers/memory/Kconfig
index 9bddca292..751c61028 100644
--- a/drivers/memory/Kconfig
+++ b/drivers/memory/Kconfig
@@ -4,6 +4,7 @@
 #
 
 menuconfig MEMORY
+	depends on !IPIPE
 	bool "Memory Controller drivers"
 
 if MEMORY
diff --git a/drivers/mfd/Kconfig b/drivers/mfd/Kconfig
index 43169f25d..30f42640a 100644
--- a/drivers/mfd/Kconfig
+++ b/drivers/mfd/Kconfig
@@ -1369,9 +1369,8 @@ config MFD_PALMAS
 
 config TPS6105X
 	tristate "TI TPS61050/61052 Boost Converters"
-	depends on I2C
+	depends on I2C && REGULATOR
 	select REGMAP_I2C
-	select REGULATOR
 	select MFD_CORE
 	select REGULATOR_FIXED_VOLTAGE
 	help
diff --git a/drivers/net/ethernet/stmicro/Kconfig b/drivers/net/ethernet/stmicro/Kconfig
index 39ef86360..d3126202d 100644
--- a/drivers/net/ethernet/stmicro/Kconfig
+++ b/drivers/net/ethernet/stmicro/Kconfig
@@ -6,7 +6,7 @@
 config NET_VENDOR_STMICRO
 	bool "STMicroelectronics devices"
 	default y
-	depends on HAS_IOMEM
+	depends on HAS_IOMEM && !IPIPE
 	---help---
 	  If you have a network (Ethernet) card based on Synopsys Ethernet IP
 	  Cores, say Y.
diff --git a/drivers/of/Kconfig b/drivers/of/Kconfig
index d91618641..ffbe547f4 100644
--- a/drivers/of/Kconfig
+++ b/drivers/of/Kconfig
@@ -4,6 +4,7 @@ config DTC
 
 menuconfig OF
 	bool "Device Tree and Open Firmware support"
+	depends on !IPIPE
 	help
 	  This option enables the device tree infrastructure.
 	  It is automatically selected by platforms that need it or can
diff --git a/drivers/pci/Kconfig b/drivers/pci/Kconfig
index a304f5ea1..d19c5102c 100644
--- a/drivers/pci/Kconfig
+++ b/drivers/pci/Kconfig
@@ -129,6 +129,7 @@ config PCI_BRIDGE_EMUL
 
 config PCI_IOV
 	bool "PCI IOV support"
+	depends on !IPIPE
 	select PCI_ATS
 	help
 	  I/O Virtualization is a PCI feature supported by some devices
@@ -139,6 +140,7 @@ config PCI_IOV
 
 config PCI_PRI
 	bool "PCI PRI support"
+	depends on !IPIPE
 	select PCI_ATS
 	help
 	  PRI is the PCI Page Request Interface. It allows PCI devices that are
@@ -148,6 +150,7 @@ config PCI_PRI
 
 config PCI_PASID
 	bool "PCI PASID support"
+	depends on !IPIPE
 	select PCI_ATS
 	help
 	  Process Address Space Identifiers (PASIDs) can be used by PCI devices
diff --git a/drivers/pci/hotplug/Kconfig b/drivers/pci/hotplug/Kconfig
index e7b493c22..2a3f9945c 100644
--- a/drivers/pci/hotplug/Kconfig
+++ b/drivers/pci/hotplug/Kconfig
@@ -5,7 +5,7 @@
 
 menuconfig HOTPLUG_PCI
 	bool "Support for PCI Hotplug"
-	depends on PCI && SYSFS
+	depends on PCI && SYSFS && !IPIPE
 	---help---
 	  Say Y here if you have a motherboard with a PCI Hotplug controller.
 	  This allows you to add and remove PCI cards while the machine is
diff --git a/drivers/pci/pcie/Kconfig b/drivers/pci/pcie/Kconfig
index 362eb8cfa..595a668e4 100644
--- a/drivers/pci/pcie/Kconfig
+++ b/drivers/pci/pcie/Kconfig
@@ -4,7 +4,7 @@
 #
 config PCIEPORTBUS
 	bool "PCI Express Port Bus support"
-	depends on PCI
+	depends on PCI && !IPIPE
 	help
 	  This enables PCI Express Port Bus support. Users can then enable
 	  support for Native Hot-Plug, Advanced Error Reporting, Power
diff --git a/drivers/perf/Kconfig b/drivers/perf/Kconfig
index 09ae8a970..ea348b4c9 100644
--- a/drivers/perf/Kconfig
+++ b/drivers/perf/Kconfig
@@ -4,7 +4,7 @@
 #
 
 menu "Performance monitor support"
-	depends on PERF_EVENTS
+	depends on PERF_EVENTS && !IPIPE
 
 config ARM_CCI_PMU
 	tristate "ARM CCI PMU driver"
diff --git a/drivers/pinctrl/Kconfig b/drivers/pinctrl/Kconfig
index b372419d6..a793785c1 100644
--- a/drivers/pinctrl/Kconfig
+++ b/drivers/pinctrl/Kconfig
@@ -5,6 +5,7 @@
 
 menuconfig PINCTRL
 	bool "Pin controllers"
+	depends on !IPIPE
 
 if PINCTRL
 
diff --git a/drivers/platform/x86/Kconfig b/drivers/platform/x86/Kconfig
index 000d5693f..e04c18da3 100644
--- a/drivers/platform/x86/Kconfig
+++ b/drivers/platform/x86/Kconfig
@@ -111,7 +111,7 @@ config ASUS_LAPTOP
 
 config DCDBAS
 	tristate "Dell Systems Management Base Driver"
-	depends on X86
+	depends on X86 && !IPIPE
 	help
 	  The Dell Systems Management Base Driver provides a sysfs interface
 	  for systems management software to perform System Management
diff --git a/drivers/power/avs/Kconfig b/drivers/power/avs/Kconfig
index b5a217b82..0ae35f708 100644
--- a/drivers/power/avs/Kconfig
+++ b/drivers/power/avs/Kconfig
@@ -1,6 +1,7 @@
 # SPDX-License-Identifier: GPL-2.0-only
 menuconfig POWER_AVS
 	bool "Adaptive Voltage Scaling class support"
+	depends on !IPIPE
 	help
 	  AVS is a power management technique which finely controls the
 	  operating voltage of a device in order to optimize (i.e. reduce)
diff --git a/drivers/power/reset/Kconfig b/drivers/power/reset/Kconfig
index a56423727..d88c974ab 100644
--- a/drivers/power/reset/Kconfig
+++ b/drivers/power/reset/Kconfig
@@ -1,6 +1,7 @@
 # SPDX-License-Identifier: GPL-2.0-only
 menuconfig POWER_RESET
 	bool "Board level reset or power off"
+	depends on !IPIPE
 	help
 	  Provides a number of drivers which either reset a complete board
 	  or shut it down, by manipulating the main power supply on the board.
diff --git a/drivers/powercap/Kconfig b/drivers/powercap/Kconfig
index dc1c1381d..2714ef411 100644
--- a/drivers/powercap/Kconfig
+++ b/drivers/powercap/Kconfig
@@ -5,6 +5,7 @@
 
 menuconfig POWERCAP
 	bool "Generic powercap sysfs driver"
+	depends on !IPIPE
 	help
 	  The power capping sysfs interface allows kernel subsystems to expose power
 	  capping settings to user space in a consistent way.  Usually, it consists
diff --git a/drivers/pwm/Kconfig b/drivers/pwm/Kconfig
index e3a251850..5884c7aec 100644
--- a/drivers/pwm/Kconfig
+++ b/drivers/pwm/Kconfig
@@ -1,6 +1,7 @@
 # SPDX-License-Identifier: GPL-2.0-only
 menuconfig PWM
 	bool "Pulse-Width Modulation (PWM) Support"
+	depends on !IPIPE
 	help
 	  Generic Pulse-Width Modulation (PWM) support.
 
diff --git a/drivers/regulator/Kconfig b/drivers/regulator/Kconfig
index 3ee63531f..5c7ccc88c 100644
--- a/drivers/regulator/Kconfig
+++ b/drivers/regulator/Kconfig
@@ -1,6 +1,7 @@
 # SPDX-License-Identifier: GPL-2.0-only
 menuconfig REGULATOR
 	bool "Voltage and Current Regulator Support"
+	depends on !IPIPE
 	help
 	  Generic Voltage and Current Regulator support.
 
diff --git a/drivers/remoteproc/Kconfig b/drivers/remoteproc/Kconfig
index 94afdde4b..797660911 100644
--- a/drivers/remoteproc/Kconfig
+++ b/drivers/remoteproc/Kconfig
@@ -1,5 +1,6 @@
 # SPDX-License-Identifier: GPL-2.0-only
 menu "Remoteproc drivers"
+	depends on !IPIPE
 
 config REMOTEPROC
 	bool "Support for Remote Processor subsystem"
diff --git a/drivers/reset/Kconfig b/drivers/reset/Kconfig
index 7b07281aa..913d6c118 100644
--- a/drivers/reset/Kconfig
+++ b/drivers/reset/Kconfig
@@ -4,6 +4,7 @@ config ARCH_HAS_RESET_CONTROLLER
 
 menuconfig RESET_CONTROLLER
 	bool "Reset Controller Support"
+	depends on !IPIPE
 	default y if ARCH_HAS_RESET_CONTROLLER
 	help
 	  Generic Reset Controller support.
diff --git a/drivers/rpmsg/Kconfig b/drivers/rpmsg/Kconfig
index d0322b41e..e11bc9ccc 100644
--- a/drivers/rpmsg/Kconfig
+++ b/drivers/rpmsg/Kconfig
@@ -1,6 +1,7 @@
 # SPDX-License-Identifier: GPL-2.0
 
 menu "Rpmsg drivers"
+	depends on !IPIPE
 
 # RPMSG always gets selected by whoever wants it
 config RPMSG
diff --git a/drivers/scsi/ufs/Kconfig b/drivers/scsi/ufs/Kconfig
index 0b845ab7c..46dd336c3 100644
--- a/drivers/scsi/ufs/Kconfig
+++ b/drivers/scsi/ufs/Kconfig
@@ -34,7 +34,7 @@
 
 config SCSI_UFSHCD
 	tristate "Universal Flash Storage Controller Driver Core"
-	depends on SCSI && SCSI_DMA
+	depends on SCSI && SCSI_DMA && !IPIPE
 	select PM_DEVFREQ
 	select DEVFREQ_GOV_SIMPLE_ONDEMAND
 	select NLS
diff --git a/drivers/sfi/Kconfig b/drivers/sfi/Kconfig
index 1878d3788..296c88690 100644
--- a/drivers/sfi/Kconfig
+++ b/drivers/sfi/Kconfig
@@ -5,6 +5,7 @@
 
 menuconfig SFI
 	bool "SFI (Simple Firmware Interface) Support"
+	depends on !IPIPE
 	---help---
 	The Simple Firmware Interface (SFI) provides a lightweight method
 	for platform firmware to pass information to the operating system
diff --git a/drivers/soc/Kconfig b/drivers/soc/Kconfig
index 833e04a78..b1266cad8 100644
--- a/drivers/soc/Kconfig
+++ b/drivers/soc/Kconfig
@@ -1,5 +1,6 @@
 # SPDX-License-Identifier: GPL-2.0-only
 menu "SOC (System On Chip) specific Drivers"
+	depends on !IPIPE
 
 source "drivers/soc/actions/Kconfig"
 source "drivers/soc/amlogic/Kconfig"
diff --git a/drivers/usb/chipidea/Kconfig b/drivers/usb/chipidea/Kconfig
index ae850b3fd..104ba9306 100644
--- a/drivers/usb/chipidea/Kconfig
+++ b/drivers/usb/chipidea/Kconfig
@@ -3,8 +3,8 @@
 config USB_CHIPIDEA
 	tristate "ChipIdea Highspeed Dual Role Controller"
 	depends on ((USB_EHCI_HCD && USB_GADGET) || (USB_EHCI_HCD && !USB_GADGET) || (!USB_EHCI_HCD && USB_GADGET)) && HAS_DMA
+	depends on RESET_CONTROLLER
 	select EXTCON
-	select RESET_CONTROLLER
 	select USB_ULPI_BUS
 	select USB_ROLE_SWITCH
 	help
diff --git a/drivers/virt/Kconfig b/drivers/virt/Kconfig
index 363af2eaf..c77208e34 100644
--- a/drivers/virt/Kconfig
+++ b/drivers/virt/Kconfig
@@ -5,6 +5,7 @@
 
 menuconfig VIRT_DRIVERS
 	bool "Virtualization drivers"
+	depends on !IPIPE
 	---help---
 	  Say Y here to get to see options for device drivers that support
 	  virtualization environments.
diff --git a/drivers/virtio/Kconfig b/drivers/virtio/Kconfig
index 078615cf2..bd66fc770 100644
--- a/drivers/virtio/Kconfig
+++ b/drivers/virtio/Kconfig
@@ -8,6 +8,7 @@ config VIRTIO
 
 menuconfig VIRTIO_MENU
 	bool "Virtio drivers"
+	depends on !IPIPE
 	default y
 
 if VIRTIO_MENU
diff --git a/drivers/watchdog/Kconfig b/drivers/watchdog/Kconfig
index 3fabd4177..d0aa38ced 100644
--- a/drivers/watchdog/Kconfig
+++ b/drivers/watchdog/Kconfig
@@ -6,6 +6,7 @@
 
 menuconfig WATCHDOG
 	bool "Watchdog Timer Support"
+	depends on !IPIPE
 	---help---
 	  If you say Y here (and to one of the following options) and create a
 	  character special file /dev/watchdog with major number 10 and minor
diff --git a/fs/Kconfig.binfmt b/fs/Kconfig.binfmt
index 62dc4f577..8a58df9d0 100644
--- a/fs/Kconfig.binfmt
+++ b/fs/Kconfig.binfmt
@@ -176,6 +176,7 @@ config BINFMT_EM86
 
 config BINFMT_MISC
 	tristate "Kernel support for MISC binaries"
+	depends on !IPIPE
 	---help---
 	  If you say Y here, it will be possible to plug wrapper-driven binary
 	  formats into the kernel. You will like this especially when you use
diff --git a/fs/verity/Kconfig b/fs/verity/Kconfig
index 88fb25119..94313b3d5 100644
--- a/fs/verity/Kconfig
+++ b/fs/verity/Kconfig
@@ -2,6 +2,7 @@
 
 config FS_VERITY
 	bool "FS Verity (read-only file-based authenticity protection)"
+	depends on !IPIPE
 	select CRYPTO
 	# SHA-256 is selected as it's intended to be the default hash algorithm.
 	# To avoid bloat, other wanted algorithms must be selected explicitly.
diff --git a/include/linux/ipipe.h b/include/linux/ipipe.h
index fe90cb55d..785d5860a 100644
--- a/include/linux/ipipe.h
+++ b/include/linux/ipipe.h
@@ -30,9 +30,7 @@
 #include <linux/thread_info.h>
 #include <linux/ipipe_debug.h>
 #include <asm/ptrace.h>
-#ifdef CONFIG_HAVE_IPIPE_SUPPORT
 #include <asm/ipipe.h>
-#endif
 
 struct cpuidle_device;
 struct cpuidle_state;
diff --git a/init/Kconfig b/init/Kconfig
index e90350c37..9fecaf3c0 100644
--- a/init/Kconfig
+++ b/init/Kconfig
@@ -88,7 +88,7 @@ config INIT_ENV_ARG_LIMIT
 
 config COMPILE_TEST
 	bool "Compile also drivers which will not load"
-	depends on HAS_IOMEM
+	depends on HAS_IOMEM && !IPIPE
 	help
 	  Some drivers can be compiled on a different platform than they are
 	  intended to be run on. Despite they cannot be loaded there (or even
@@ -283,7 +283,7 @@ config ARCH_NO_SWAP
 
 config SWAP
 	bool "Support for paging of anonymous memory (swap)"
-	depends on MMU && BLOCK && !ARCH_NO_SWAP
+	depends on MMU && BLOCK && !ARCH_NO_SWAP && !IPIPE
 	default y
 	help
 	  This option allows you to choose whether you want to have support
@@ -346,6 +346,7 @@ config CROSS_MEMORY_ATTACH
 
 config USELIB
 	bool "uselib syscall"
+	depends on !IPIPE
 	def_bool ALPHA || M68K || SPARC || X86_32 || IA32_EMULATION
 	help
 	  This option enables the uselib syscall, a system call used in the
@@ -356,7 +357,7 @@ config USELIB
 
 config AUDIT
 	bool "Auditing support"
-	depends on NET
+	depends on NET && !IPIPE
 	help
 	  Enable auditing infrastructure that can be used with another
 	  kernel subsystem, such as SELinux (which requires this for
@@ -433,6 +434,7 @@ endchoice
 config IRQ_TIME_ACCOUNTING
 	bool "Fine granularity task level IRQ time accounting"
 	depends on HAVE_IRQ_TIME_ACCOUNTING && !VIRT_CPU_ACCOUNTING_NATIVE
+	depends on !IPIPE
 	help
 	  Select this option to enable fine granularity task irq time
 	  accounting. This is done by reading a timestamp on each
@@ -874,6 +876,7 @@ config CGROUP_WRITEBACK
 
 menuconfig CGROUP_SCHED
 	bool "CPU controller"
+	depends on !IPIPE
 	default n
 	help
 	  This feature lets CPU scheduler recognize task groups and control CPU
@@ -987,7 +990,7 @@ config CGROUP_HUGETLB
 
 config CPUSETS
 	bool "Cpuset controller"
-	depends on SMP
+	depends on SMP && !IPIPE
 	help
 	  This option will let you create and manage CPUSETs which
 	  allow dynamically partitioning a system into sets of CPUs and
@@ -1015,7 +1018,7 @@ config CGROUP_CPUACCT
 
 config CGROUP_PERF
 	bool "Perf controller"
-	depends on PERF_EVENTS
+	depends on PERF_EVENTS && !IPIPE
 	help
 	  This option extends the perf per-cpu mode to restrict monitoring
 	  to threads which belong to the cgroup specified and run on the
@@ -1127,6 +1130,7 @@ config CHECKPOINT_RESTORE
 
 config SCHED_AUTOGROUP
 	bool "Automatic process group scheduling"
+	depends on !IPIPE
 	select CGROUPS
 	select CGROUP_SCHED
 	select FAIR_GROUP_SCHED
@@ -1228,6 +1232,7 @@ config CC_OPTIMIZE_FOR_PERFORMANCE_O3
 
 config CC_OPTIMIZE_FOR_SIZE
 	bool "Optimize for size (-Os)"
+	depends on !IPIPE
 	help
 	  Choosing this option will pass "-Os" to your compiler resulting
 	  in a smaller kernel.
@@ -1247,7 +1252,7 @@ config HAVE_LD_DEAD_CODE_DATA_ELIMINATION
 config LD_DEAD_CODE_DATA_ELIMINATION
 	bool "Dead code and data elimination (EXPERIMENTAL)"
 	depends on HAVE_LD_DEAD_CODE_DATA_ELIMINATION
-	depends on EXPERT
+	depends on EXPERT && !IPIPE
 	depends on !(FUNCTION_TRACER && CC_IS_GCC && GCC_VERSION < 40800)
 	depends on $(cc-option,-ffunction-sections -fdata-sections)
 	depends on $(ld-option,--gc-sections)
@@ -1298,8 +1303,6 @@ config BPF
 
 menuconfig EXPERT
 	bool "Configure standard kernel features (expert users)"
-	# Unhide debug options, to make the on-by-default options visible
-	select DEBUG_KERNEL
 	help
 	  This option allows certain base kernel options and settings
           to be disabled or tweaked. This is for specialized
@@ -1349,7 +1352,7 @@ config SYSFS_SYSCALL
 
 config SYSCTL_SYSCALL
 	bool "Sysctl syscall support" if EXPERT
-	depends on PROC_SYSCTL
+	depends on PROC_SYSCTL && !IPIPE
 	default n
 	select SYSCTL
 	---help---
@@ -1760,7 +1763,7 @@ config VM_EVENT_COUNTERS
 config SLUB_DEBUG
 	default y
 	bool "Enable SLUB debugging support" if EXPERT
-	depends on SLUB && SYSFS
+	depends on SLUB && SYSFS && !IPIPE
 	help
 	  SLUB has extensive debug support features. Disabling these can
 	  result in significant savings in code size. This also disables
@@ -1770,7 +1773,7 @@ config SLUB_DEBUG
 config SLUB_MEMCG_SYSFS_ON
 	default n
 	bool "Enable memcg SLUB sysfs support by default" if EXPERT
-	depends on SLUB && SYSFS && MEMCG
+	depends on SLUB && SYSFS && MEMCG && !IPIPE
 	help
 	  SLUB creates a directory under /sys/kernel/slab for each
 	  allocation cache to host info and debug files. If memory
@@ -1886,7 +1889,7 @@ config SHUFFLE_PAGE_ALLOCATOR
 
 config SLUB_CPU_PARTIAL
 	default y
-	depends on SLUB && SMP
+	depends on SLUB && SMP && !IPIPE
 	bool "SLUB per cpu partial cache"
 	help
 	  Per cpu partial caches accelerate objects allocation and freeing
@@ -1919,6 +1922,7 @@ config MMAP_ALLOW_UNINITIALIZED
 
 config SYSTEM_DATA_VERIFICATION
 	def_bool n
+	depends on !IPIPE
 	select SYSTEM_TRUSTED_KEYRING
 	select KEYS
 	select CRYPTO
@@ -1937,6 +1941,7 @@ config SYSTEM_DATA_VERIFICATION
 
 config PROFILING
 	bool "Profiling support"
+	depends on !IPIPE
 	help
 	  Say Y here to enable the extended profiling support mechanisms used
 	  by profilers such as OProfile.
@@ -2015,6 +2020,7 @@ config MODULE_FORCE_UNLOAD
 
 config MODVERSIONS
 	bool "Module versioning support"
+	depends on !IPIPE
 	help
 	  Usually, you have to use modules compiled with your kernel.
 	  Saying Y here makes it sometimes possible to use modules
@@ -2048,6 +2054,7 @@ config MODULE_SRCVERSION_ALL
 
 config MODULE_SIG
 	bool "Module signature verification"
+	depends on !IPIPE
 	select MODULE_SIG_FORMAT
 	help
 	  Check modules for valid signatures upon load: the signature
@@ -2179,6 +2186,7 @@ config MODULE_ALLOW_MISSING_NAMESPACE_IMPORTS
 
 config UNUSED_SYMBOLS
 	bool "Enable unused/obsolete exported symbols"
+	depends on !IPIPE
 	default y if X86
 	help
 	  Unused but exported symbols make the kernel needlessly bigger.  For
@@ -2195,7 +2203,7 @@ config UNUSED_SYMBOLS
 
 config TRIM_UNUSED_KSYMS
 	bool "Trim unused exported kernel symbols"
-	depends on !UNUSED_SYMBOLS
+	depends on !UNUSED_SYMBOLS && !IPIPE
 	help
 	  The kernel and some modules make many symbols available for
 	  other modules to use via EXPORT_SYMBOL() and variants. Depending
diff --git a/kernel/dma/Kconfig b/kernel/dma/Kconfig
index 73c5c2b8e..60cd885a4 100644
--- a/kernel/dma/Kconfig
+++ b/kernel/dma/Kconfig
@@ -156,6 +156,7 @@ endif
 
 config DMA_API_DEBUG
 	bool "Enable debugging of DMA-API usage"
+	depends on !IPIPE
 	select NEED_DMA_MAP_STATE
 	help
 	  Enable this option to debug the use of the DMA API by device drivers.
@@ -176,7 +177,7 @@ config DMA_API_DEBUG
 config DMA_API_DEBUG_SG
 	bool "Debug DMA scatter-gather usage"
 	default y
-	depends on DMA_API_DEBUG
+	depends on DMA_API_DEBUG && !IPIPE
 	help
 	  Perform extra checking that callers of dma_map_sg() have respected the
 	  appropriate segment length/boundary limits for the given device when
diff --git a/kernel/gcov/Kconfig b/kernel/gcov/Kconfig
index 3941a9c48..e2bdbced7 100644
--- a/kernel/gcov/Kconfig
+++ b/kernel/gcov/Kconfig
@@ -1,5 +1,6 @@
 # SPDX-License-Identifier: GPL-2.0-only
 menu "GCOV-based kernel profiling"
+	depends on !IPIPE
 
 config GCOV_KERNEL
 	bool "Enable gcov-based kernel profiling"
diff --git a/kernel/ipipe/Kconfig b/kernel/ipipe/Kconfig
index d17edb89f..d0da39b3a 100644
--- a/kernel/ipipe/Kconfig
+++ b/kernel/ipipe/Kconfig
@@ -1,12 +1,37 @@
 
-config HAVE_IPIPE_SUPPORT
-       depends on GENERIC_CLOCKEVENTS
-       bool
-
 config IPIPE
 	bool "Interrupt pipeline"
-	depends on HAVE_IPIPE_SUPPORT
-	default n
+	default y
+	select 64BIT
+	select ACPI
+	select AIO
+	select BUG
+	select COREDUMP
+	select DEBUG_BUGVERBOSE
+	select DOUBLEFAULT
+	select ELF_CORE
+	select EMBEDDED
+	select EXPERT
+	select FB
+	select FB_SIMPLE
+	select FRAMEBUFFER_CONSOLE
+	select HIGH_RES_TIMERS
+	select KALLSYMS
+	select MODULES
+	select MODULE_UNLOAD
+	select PANIC_ON_OOPS
+	select PCI
+	select POSIX_TIMERS
+	select PRINTK
+	select PROC_FS
+	select PROC_SYSCTL
+	select SCHED_OMIT_FRAME_POINTER
+	select SYSFS
+	select TTY
+	select VGA_CONSOLE
+	select VT
+	select X86_PM_TIMER
+	select X86_SYSFB
 	---help---
 	  Activate this option if you want the interrupt pipeline to be
 	  compiled in.
@@ -37,11 +62,3 @@ config IPIPE_TARGET_APIREV
 
 config IPIPE_HAVE_HOSTRT
        bool
-
-config IPIPE_HAVE_EAGER_FPU
-	bool
-
-if IPIPE && ARM && RAW_PRINTK && !DEBUG_LL
-comment "CAUTION: DEBUG_LL must be selected, and properly configured for"
-comment "RAW_PRINTK to work. Otherwise, you will get no output on raw_printk()"
-endif
diff --git a/kernel/ipipe/Kconfig.debug b/kernel/ipipe/Kconfig.debug
index d1894cf62..05a410b04 100644
--- a/kernel/ipipe/Kconfig.debug
+++ b/kernel/ipipe/Kconfig.debug
@@ -6,7 +6,6 @@ config IPIPE_DEBUG
 config IPIPE_DEBUG_CONTEXT
 	bool "Check for illicit cross-domain calls"
 	depends on IPIPE_DEBUG
-	default y
 	---help---
 	  Enable this feature to arm checkpoints in the kernel that
 	  verify the correct invocation context. On entry of critical
@@ -16,7 +15,6 @@ config IPIPE_DEBUG_CONTEXT
 config IPIPE_DEBUG_INTERNAL
 	bool "Enable internal debug checks"
 	depends on IPIPE_DEBUG
-	default y
 	---help---
 	  When this feature is enabled, I-pipe will perform internal
 	  consistency checks of its subsystems, e.g. on per-cpu variable
@@ -45,7 +43,6 @@ if IPIPE_TRACE
 
 config IPIPE_TRACE_ENABLE
 	bool "Enable tracing on boot"
-	default y
 	---help---
 	  Disable this option if you want to arm the tracer after booting
 	  manually ("echo 1 > /proc/ipipe/tracer/enable"). This can reduce
@@ -53,7 +50,6 @@ config IPIPE_TRACE_ENABLE
 
 config IPIPE_TRACE_MCOUNT
 	bool "Instrument function entries"
-	default y
 	select FTRACE
 	select FUNCTION_TRACER
 	---help---
@@ -65,7 +61,6 @@ config IPIPE_TRACE_MCOUNT
 
 config IPIPE_TRACE_IRQSOFF
 	bool "Trace IRQs-off times"
-	default y
 	---help---
 	  Activate this option if I-pipe shall trace the longest path
 	  with hard-IRQs switched off.
@@ -80,7 +75,6 @@ config IPIPE_TRACE_SHIFT
 
 config IPIPE_TRACE_VMALLOC
 	bool "Use vmalloc'ed trace buffer"
-	default y if EMBEDDED
 	---help---
 	  Instead of reserving static kernel data, the required buffer
 	  is allocated via vmalloc during boot-up when this option is
diff --git a/kernel/irq/Kconfig b/kernel/irq/Kconfig
index 4e1112026..d33749837 100644
--- a/kernel/irq/Kconfig
+++ b/kernel/irq/Kconfig
@@ -127,7 +127,7 @@ config SPARSE_IRQ
 
 config GENERIC_IRQ_DEBUGFS
 	bool "Expose irq internals in debugfs"
-	depends on DEBUG_FS
+	depends on DEBUG_FS && !IPIPE
 	default n
 	---help---
 
diff --git a/kernel/power/Kconfig b/kernel/power/Kconfig
index d3667b407..2a5f7fbf8 100644
--- a/kernel/power/Kconfig
+++ b/kernel/power/Kconfig
@@ -1,7 +1,7 @@
 # SPDX-License-Identifier: GPL-2.0-only
 config SUSPEND
 	bool "Suspend to RAM and standby"
-	depends on ARCH_SUSPEND_POSSIBLE
+	depends on ARCH_SUSPEND_POSSIBLE && !IPIPE
 	default y
 	---help---
 	  Allow the system to enter sleep states in which main memory is
@@ -153,6 +153,7 @@ config PM_WAKELOCKS_GC
 
 config PM
 	bool "Device power management core functionality"
+	depends on !IPIPE
 	---help---
 	  Enable functionality allowing I/O devices to be put into energy-saving
 	  (low power) states, for example after a specified period of inactivity
diff --git a/kernel/trace/Kconfig b/kernel/trace/Kconfig
index f03600835..d9ff3c7b4 100644
--- a/kernel/trace/Kconfig
+++ b/kernel/trace/Kconfig
@@ -133,6 +133,7 @@ if TRACING_SUPPORT
 
 menuconfig FTRACE
 	bool "Tracers"
+	depends on IPIPE_TRACE || !IPIPE
 	default y if DEBUG_KERNEL
 	help
 	  Enable the kernel tracing infrastructure.
diff --git a/lib/Kconfig.debug b/lib/Kconfig.debug
index 0c35ef335..f865a9786 100644
--- a/lib/Kconfig.debug
+++ b/lib/Kconfig.debug
@@ -99,6 +99,7 @@ config DYNAMIC_DEBUG
 	default n
 	depends on PRINTK
 	depends on DEBUG_FS
+	depends on !IPIPE
 	help
 
 	  Compiles debug level messages into the kernel, which would not
@@ -264,7 +265,7 @@ config FRAME_WARN
 
 config STRIP_ASM_SYMS
 	bool "Strip assembler-generated symbols during link"
-	default n
+	default y
 	help
 	  Strip internal assembler-generated symbols during a link (symbols
 	  that look like '.Lxxx') so they don't pollute the output of
@@ -315,6 +316,7 @@ config OPTIMIZE_INLINING
 
 config DEBUG_SECTION_MISMATCH
 	bool "Enable full Section mismatch analysis"
+	depends on !IPIPE
 	help
 	  The section mismatch analysis checks if there are illegal
 	  references from one section to another section.
@@ -343,6 +345,17 @@ config SECTION_MISMATCH_WARN_ONLY
 
 	  If unsure, say Y.
 
+config DEBUG_FORCE_FUNCTION_ALIGN_64B
+	bool "Force all function address 64B aligned" if EXPERT
+	help
+	  There are cases that a commit from one domain changes the function
+	  address alignment of other domains, and cause magic performance
+	  bump (regression or improvement). Enable this option will help to
+	  verify if the bump is caused by function alignment changes, while
+	  it will slightly increase the kernel size and affect icache usage.
+
+	  It is mainly for debug and performance tuning use.
+
 #
 # Select this config option from the architecture Kconfig, if it
 # is preferred to always offer frame pointers as a config
@@ -362,7 +375,7 @@ config FRAME_POINTER
 
 config STACK_VALIDATION
 	bool "Compile-time stack metadata validation"
-	depends on HAVE_STACK_VALIDATION
+	depends on HAVE_STACK_VALIDATION && !IPIPE
 	default n
 	help
 	  Add compile-time checks to validate stack metadata, including frame
@@ -430,6 +443,7 @@ source "kernel/ipipe/Kconfig.debug"
 
 config DEBUG_KERNEL
 	bool "Kernel debugging"
+	depends on !IPIPE
 	help
 	  Say Y here if you are developing drivers or trying to debug and
 	  identify kernel problems.
@@ -532,7 +546,7 @@ config SLUB_DEBUG_ON
 config SLUB_STATS
 	default n
 	bool "Enable SLUB performance statistics"
-	depends on SLUB && SYSFS
+	depends on SLUB && SYSFS && !IPIPE
 	help
 	  SLUB statistics are useful to debug SLUBs allocation behavior in
 	  order find ways to optimize the allocator. This should never be
@@ -808,7 +822,15 @@ config DEBUG_SHIRQ
 	  Drivers ought to be able to handle interrupts coming in at those
 	  points; some don't and need to be caught.
 
+#
+# Enables a timestamp based low pass filter to compensate for perf based
+# hard lockup detection which runs too fast due to turbo modes.
+#
+config HARDLOCKUP_CHECK_TIMESTAMP
+	bool
+
 menu "Debug Lockups and Hangs"
+	depends on !IPIPE
 
 config LOCKUP_DETECTOR
 	bool
@@ -854,13 +876,6 @@ config HARDLOCKUP_DETECTOR_PERF
 	bool
 	select SOFTLOCKUP_DETECTOR
 
-#
-# Enables a timestamp based low pass filter to compensate for perf based
-# hard lockup detection which runs too fast due to turbo modes.
-#
-config HARDLOCKUP_CHECK_TIMESTAMP
-	bool
-
 #
 # arch/ can define HAVE_HARDLOCKUP_DETECTOR_ARCH to provide their own hard
 # lockup detector rather than the perf based detector.
@@ -1033,6 +1048,7 @@ config SCHED_STACK_END_CHECK
 
 config DEBUG_TIMEKEEPING
 	bool "Enable extra timekeeping sanity checking"
+	depends on !IPIPE
 	help
 	  This option will enable additional timekeeping sanity checks
 	  which may be helpful when diagnosing issues where timekeeping
@@ -1055,6 +1071,7 @@ config DEBUG_PREEMPT
 	  will detect preemption count underflows.
 
 menu "Lock Debugging (spinlocks, mutexes, etc...)"
+	depends on !IPIPE
 
 config LOCK_DEBUGGING_SUPPORT
 	bool
@@ -1333,7 +1350,7 @@ config HAVE_DEBUG_BUGVERBOSE
 	bool
 
 config DEBUG_BUGVERBOSE
-	bool "Verbose BUG() reporting (adds 70K)" if DEBUG_KERNEL && EXPERT
+	bool "Verbose BUG() reporting (adds 70K)" if DEBUG_KERNEL || EXPERT
 	depends on BUG && (GENERIC_BUG || HAVE_DEBUG_BUGVERBOSE)
 	default y
 	help
@@ -1629,7 +1646,7 @@ source "kernel/trace/Kconfig"
 
 config PROVIDE_OHCI1394_DMA_INIT
 	bool "Remote debugging over FireWire early on boot"
-	depends on PCI && X86
+	depends on PCI && X86 && !IPIPE
 	help
 	  If you want to debug problems which hang or crash the kernel early
 	  on boot and the crashing machine has a FireWire port, you can use
@@ -1658,6 +1675,7 @@ config PROVIDE_OHCI1394_DMA_INIT
 
 menuconfig RUNTIME_TESTING_MENU
 	bool "Runtime Testing"
+	depends on !IPIPE
 	def_bool y
 
 if RUNTIME_TESTING_MENU
@@ -2064,6 +2082,7 @@ endif # RUNTIME_TESTING_MENU
 
 config MEMTEST
 	bool "Memtest"
+	depends on !IPIPE
 	---help---
 	  This option adds a kernel parameter 'memtest', which allows memtest
 	  to be set.
diff --git a/lib/Kconfig.ubsan b/lib/Kconfig.ubsan
index 0e04fcb3a..72e7783af 100644
--- a/lib/Kconfig.ubsan
+++ b/lib/Kconfig.ubsan
@@ -4,6 +4,7 @@ config ARCH_HAS_UBSAN_SANITIZE_ALL
 
 config UBSAN
 	bool "Undefined behaviour sanity checker"
+	depends on !IPIPE
 	help
 	  This option enables undefined behaviour sanity checker
 	  Compile-time instrumentation is used to detect various undefined
diff --git a/lib/xz/Kconfig b/lib/xz/Kconfig
index 22528743d..5d6c394b0 100644
--- a/lib/xz/Kconfig
+++ b/lib/xz/Kconfig
@@ -17,26 +17,31 @@ config XZ_DEC_X86
 config XZ_DEC_POWERPC
 	bool "PowerPC BCJ filter decoder" if EXPERT
 	default y
+	depends on PPC
 	select XZ_DEC_BCJ
 
 config XZ_DEC_IA64
 	bool "IA-64 BCJ filter decoder" if EXPERT
 	default y
+	depends on IA64
 	select XZ_DEC_BCJ
 
 config XZ_DEC_ARM
 	bool "ARM BCJ filter decoder" if EXPERT
 	default y
+	depends on ARM
 	select XZ_DEC_BCJ
 
 config XZ_DEC_ARMTHUMB
 	bool "ARM-Thumb BCJ filter decoder" if EXPERT
 	default y
+	depends on ARM_THUMB || ARM_THUMBEE
 	select XZ_DEC_BCJ
 
 config XZ_DEC_SPARC
 	bool "SPARC BCJ filter decoder" if EXPERT
 	default y
+	depends on SPARC
 	select XZ_DEC_BCJ
 
 endif
diff --git a/mm/Kconfig b/mm/Kconfig
index fbdc5c70e..daefa826d 100644
--- a/mm/Kconfig
+++ b/mm/Kconfig
@@ -153,7 +153,7 @@ config HAVE_BOOTMEM_INFO_NODE
 config MEMORY_HOTPLUG
 	bool "Allow for memory hot-add"
 	depends on SPARSEMEM || X86_64_ACPI_NUMA
-	depends on ARCH_ENABLE_MEMORY_HOTPLUG
+	depends on ARCH_ENABLE_MEMORY_HOTPLUG && !IPIPE
 
 config MEMORY_HOTPLUG_SPARSE
 	def_bool y
@@ -513,6 +513,7 @@ config CMA_AREAS
 config MEM_SOFT_DIRTY
 	bool "Track memory changes"
 	depends on CHECKPOINT_RESTORE && HAVE_ARCH_SOFT_DIRTY && PROC_FS
+	depends on !IPIPE
 	select PROC_PAGE_MONITOR
 	help
 	  This option enables memory changes tracking by introducing a
@@ -620,7 +621,7 @@ config DEFERRED_STRUCT_PAGE_INIT
 
 config IDLE_PAGE_TRACKING
 	bool "Enable idle page tracking"
-	depends on SYSFS && MMU
+	depends on SYSFS && MMU && !IPIPE
 	select PAGE_EXTENSION if !64BIT
 	help
 	  This feature allows to estimate the amount of user pages that have
@@ -683,6 +684,7 @@ config ARCH_HAS_PKEYS
 
 config PERCPU_STATS
 	bool "Collect percpu memory statistics"
+	depends on !IPIPE
 	help
 	  This feature collects and exposes statistics via debugfs. The
 	  information includes global and per chunk statistics, which can
diff --git a/mm/Kconfig.debug b/mm/Kconfig.debug
index 327b3ebf2..8037422e9 100644
--- a/mm/Kconfig.debug
+++ b/mm/Kconfig.debug
@@ -1,6 +1,7 @@
 # SPDX-License-Identifier: GPL-2.0-only
 config PAGE_EXTENSION
 	bool "Extend memmap on extra space for more information on page"
+	depends on !IPIPE
 	---help---
 	  Extend memmap on extra space for more information on page. This
 	  could be used for debugging features that need to insert extra
@@ -64,6 +65,7 @@ config PAGE_OWNER
 
 config PAGE_POISONING
 	bool "Poison pages after freeing"
+	depends on !IPIPE
 	select PAGE_POISONING_NO_SANITY if HIBERNATION
 	---help---
 	  Fill the pages with poison patterns after free_pages() and verify
diff --git a/net/wireless/Kconfig b/net/wireless/Kconfig
index 211007c09..5b410a393 100644
--- a/net/wireless/Kconfig
+++ b/net/wireless/Kconfig
@@ -90,8 +90,8 @@ config CFG80211_CERTIFICATION_ONUS
 
 config CFG80211_REQUIRE_SIGNED_REGDB
 	bool "require regdb signature" if CFG80211_CERTIFICATION_ONUS
-	default y
-	select SYSTEM_DATA_VERIFICATION
+	default n
+	depends on SYSTEM_DATA_VERIFICATION
 	help
 	  Require that in addition to the "regulatory.db" file a
 	  "regulatory.db.p7s" can be loaded with a valid PKCS#7
diff --git a/samples/Kconfig b/samples/Kconfig
index c8dacb4dd..c1beba3c0 100644
--- a/samples/Kconfig
+++ b/samples/Kconfig
@@ -1,6 +1,7 @@
 # SPDX-License-Identifier: GPL-2.0-only
 menuconfig SAMPLES
 	bool "Sample kernel code"
+	depends on !IPIPE
 	help
 	  You can build and test sample kernel code here.
 
diff --git a/security/Kconfig b/security/Kconfig
index 52e5109f2..321af7bab 100644
--- a/security/Kconfig
+++ b/security/Kconfig
@@ -9,6 +9,7 @@ source "security/keys/Kconfig"
 
 config SECURITY_DMESG_RESTRICT
 	bool "Restrict unprivileged access to the kernel syslog"
+	depends on !IPIPE
 	default n
 	help
 	  This enforces restrictions on unprivileged users reading the kernel
@@ -23,6 +24,7 @@ config SECURITY
 	bool "Enable different security models"
 	depends on SYSFS
 	depends on MULTIUSER
+	depends on !IPIPE
 	help
 	  This allows you to choose different security modules to be
 	  configured into your kernel.
@@ -39,6 +41,7 @@ config SECURITY_WRITABLE_HOOKS
 
 config SECURITYFS
 	bool "Enable the securityfs filesystem"
+	depends on !IPIPE
 	help
 	  This will build the securityfs filesystem.  It is currently used by
 	  various security modules (AppArmor, IMA, SafeSetID, TOMOYO, TPM).
@@ -57,7 +60,7 @@ config SECURITY_NETWORK
 config PAGE_TABLE_ISOLATION
 	bool "Remove the kernel mapping in user mode"
 	default y
-	depends on (X86_64 || X86_PAE) && !UML
+	depends on (X86_64 || X86_PAE) && !UML && !IPIPE
 	help
 	  This feature reduces the number of hardware side channels by
 	  ensuring that the majority of kernel addresses are not mapped
@@ -152,7 +155,7 @@ config HAVE_HARDENED_USERCOPY_ALLOCATOR
 
 config HARDENED_USERCOPY
 	bool "Harden memory copies between kernel and userspace"
-	depends on HAVE_HARDENED_USERCOPY_ALLOCATOR
+	depends on HAVE_HARDENED_USERCOPY_ALLOCATOR && !IPIPE
 	imply STRICT_DEVMEM
 	help
 	  This option checks for obviously wrong memory regions when
diff --git a/security/Kconfig.hardening b/security/Kconfig.hardening
index af4c979b3..5c3f5d3df 100644
--- a/security/Kconfig.hardening
+++ b/security/Kconfig.hardening
@@ -169,6 +169,7 @@ config STACKLEAK_RUNTIME_DISABLE
 
 config INIT_ON_ALLOC_DEFAULT_ON
 	bool "Enable heap memory zeroing on allocation by default"
+	depends on !IPIPE
 	help
 	  This has the effect of setting "init_on_alloc=1" on the kernel
 	  command line. This can be disabled with "init_on_alloc=0".
@@ -181,6 +182,7 @@ config INIT_ON_ALLOC_DEFAULT_ON
 
 config INIT_ON_FREE_DEFAULT_ON
 	bool "Enable heap memory zeroing on free by default"
+	depends on !IPIPE
 	help
 	  This has the effect of setting "init_on_free=1" on the kernel
 	  command line. This can be disabled with "init_on_free=0".
diff --git a/sound/soc/Kconfig b/sound/soc/Kconfig
index bdc305cec..63d63e58a 100644
--- a/sound/soc/Kconfig
+++ b/sound/soc/Kconfig
@@ -5,6 +5,7 @@
 
 menuconfig SND_SOC
 	tristate "ALSA for SoC audio support"
+	depends on !IPIPE
 	select SND_PCM
 	select AC97_BUS if SND_SOC_AC97_BUS
 	select SND_JACK
-- 
2.30.2

