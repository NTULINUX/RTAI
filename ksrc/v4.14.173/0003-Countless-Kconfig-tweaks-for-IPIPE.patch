From dda9fd1ac971cdbd6ee779ed2b66499eb70a0119 Mon Sep 17 00:00:00 2001
From: Alec Ari <neotheuser@ymail.com>
Date: Mon, 16 Mar 2020 03:42:24 -0500
Subject: Countless Kconfig tweaks for IPIPE

Disables every problematic option I can think of and enables
several very important options for debugging. RTAI may cause
kernel panics on some systems so it is a good idea to always
have these on.

Various other fixes and optimizations are included as well.

DRM drivers (including those that depend on WMI such as
Intel and Nouveau) are now re-enabled. If you experience
long latency delays, it is highly recommended to disable
these drivers as a troubleshooting step.

Signed-off-by: Alec Ari <neotheuser@ymail.com>
---
 arch/Kconfig                        |   5 +-
 arch/x86/Kconfig                    |  75 ++++++++++++--------
 arch/x86/Kconfig.debug              |  33 +++++----
 arch/x86/events/Kconfig             |   1 +
 arch/x86/kvm/Kconfig                |   1 +
 drivers/acpi/Kconfig                |  26 ++++---
 drivers/acpi/apei/Kconfig           |   2 +-
 drivers/acpi/dptf/Kconfig           |   2 +-
 drivers/acpi/nfit/Kconfig           |   1 +
 drivers/bus/Kconfig                 |   1 +
 drivers/char/ipmi/Kconfig           |   2 +-
 drivers/char/tpm/Kconfig            |   2 +-
 drivers/clk/Kconfig                 |   2 +-
 drivers/clocksource/Kconfig         |  21 +++---
 drivers/cpufreq/Kconfig             |   1 +
 drivers/cpuidle/Kconfig             |   1 +
 drivers/crypto/Kconfig              |   1 +
 drivers/devfreq/Kconfig             |   1 +
 drivers/firmware/Kconfig            |   2 +-
 drivers/firmware/tegra/Kconfig      |   1 +
 drivers/fsi/Kconfig                 |   1 +
 drivers/gpu/drm/i915/Kconfig        |   2 +
 drivers/gpu/drm/nouveau/Kconfig     |  12 ++--
 drivers/hv/Kconfig                  |   1 +
 drivers/hwspinlock/Kconfig          |   1 +
 drivers/i2c/Kconfig                 |   2 +-
 drivers/infiniband/hw/usnic/Kconfig |   1 +
 drivers/iommu/Kconfig               |   2 +-
 drivers/mailbox/Kconfig             |   1 +
 drivers/misc/mic/Kconfig            |   3 +-
 drivers/misc/vmw_vmci/Kconfig       |   2 +-
 drivers/net/caif/Kconfig            |   3 +-
 drivers/of/Kconfig                  |   1 +
 drivers/pci/Kconfig                 |   9 +--
 drivers/pci/hotplug/Kconfig         |   2 +-
 drivers/pci/pcie/Kconfig            |   2 +-
 drivers/perf/Kconfig                |   2 +-
 drivers/pinctrl/Kconfig             |   2 +-
 drivers/power/avs/Kconfig           |   1 +
 drivers/power/reset/Kconfig         |   1 +
 drivers/powercap/Kconfig            |   1 +
 drivers/pwm/Kconfig                 |   1 +
 drivers/regulator/Kconfig           |   1 +
 drivers/remoteproc/Kconfig          |   4 +-
 drivers/reset/Kconfig               |   2 +-
 drivers/rpmsg/Kconfig               |   3 +-
 drivers/scsi/ufs/Kconfig            |   2 +-
 drivers/soc/Kconfig                 |   1 +
 drivers/virt/Kconfig                |   1 +
 drivers/virtio/Kconfig              |   2 +
 drivers/watchdog/Kconfig            |   1 +
 fs/Kconfig.binfmt                   |   1 +
 init/Kconfig                        |  37 ++++++----
 kernel/ipipe/Kconfig                |  12 +++-
 kernel/irq/Kconfig                  |   4 +-
 kernel/power/Kconfig                |   6 +-
 kernel/rcu/Kconfig.debug            |   8 +--
 kernel/trace/Kconfig                |   3 +-
 lib/Kconfig.debug                   | 102 +++++++++++++++-------------
 lib/Kconfig.kasan                   |   1 +
 lib/Kconfig.kgdb                    |   2 +-
 lib/Kconfig.ubsan                   |   1 +
 lib/xz/Kconfig                      |   5 ++
 mm/Kconfig                          |   3 +-
 mm/Kconfig.debug                    |   6 +-
 samples/Kconfig                     |   1 +
 security/Kconfig                    |   6 +-
 67 files changed, 272 insertions(+), 177 deletions(-)

diff --git a/arch/Kconfig b/arch/Kconfig
index 77b3e21c4844..782589f1cb1f 100644
--- a/arch/Kconfig
+++ b/arch/Kconfig
@@ -402,7 +402,7 @@ config HAVE_GCC_PLUGINS
 menuconfig GCC_PLUGINS
 	bool "GCC plugins"
 	depends on HAVE_GCC_PLUGINS
-	depends on !COMPILE_TEST
+	depends on !COMPILE_TEST && !IPIPE
 	help
 	  GCC plugins are loadable modules that provide extra features to the
 	  compiler. They are useful for runtime instrumentation and static analysis.
@@ -570,6 +570,7 @@ config CC_STACKPROTECTOR_REGULAR
 
 config CC_STACKPROTECTOR_STRONG
 	bool "Strong"
+	depends on !IPIPE
 	select CC_STACKPROTECTOR
 	help
 	  Functions will have the stack-protector canary logic added in any
@@ -598,6 +599,7 @@ config THIN_ARCHIVES
 
 config LD_DEAD_CODE_DATA_ELIMINATION
 	bool
+	depends on !IPIPE
 	help
 	  Select this if the architecture wants to do dead code and
 	  data elimination with the linker by compiling with
@@ -958,6 +960,7 @@ config ARCH_HAS_REFCOUNT
 
 config REFCOUNT_FULL
 	bool "Perform full reference count validation at the expense of speed"
+	depends on !IPIPE
 	help
 	  Enabling this switches the refcounting infrastructure from a fast
 	  unchecked atomic_t implementation to a fully state checked
diff --git a/arch/x86/Kconfig b/arch/x86/Kconfig
index 6ac24aa7bbc0..d8dc135ee017 100644
--- a/arch/x86/Kconfig
+++ b/arch/x86/Kconfig
@@ -147,10 +147,6 @@ config X86
 	select HAVE_IRQ_TIME_ACCOUNTING
 	select HAVE_IPIPE_SUPPORT		if X86_64
 	select HAVE_IPIPE_TRACER_SUPPORT
-	select IPIPE_HAVE_HOSTRT if IPIPE
-	select IPIPE_HAVE_SAFE_THREAD_INFO if IPIPE
-	select IPIPE_WANT_PTE_PINNING if IPIPE
-	select IPIPE_HAVE_VM_NOTIFIER if IPIPE
 	select HAVE_KERNEL_BZIP2
 	select HAVE_KERNEL_GZIP
 	select HAVE_KERNEL_LZ4
@@ -184,6 +180,12 @@ config X86
 	select HAVE_UNSTABLE_SCHED_CLOCK
 	select HAVE_USER_RETURN_NOTIFIER
 	select HOTPLUG_SMT			if SMP
+	# Disabling IPIPE is broken right now (Xenomai mainline)
+	select IPIPE				if X86_64
+	select IPIPE_HAVE_HOSTRT if IPIPE
+	select IPIPE_HAVE_SAFE_THREAD_INFO if IPIPE
+	select IPIPE_HAVE_VM_NOTIFIER if IPIPE
+	select IPIPE_WANT_PTE_PINNING if IPIPE
 	select IRQ_FORCED_THREADING
 	select PCI_LOCKLESS_CONFIG
 	select PERF_EVENTS
@@ -421,7 +423,7 @@ config X86_X2APIC
 config X86_MPPARSE
 	bool "Enable MPS table" if ACPI || SFI
 	default y
-	depends on X86_LOCAL_APIC
+	depends on X86_LOCAL_APIC && !IPIPE
 	---help---
 	  For old smp systems that do not have proper acpi support. Newer systems
 	  (esp with 64bit cpus) with acpi support, MADT and DSDT will override it
@@ -439,6 +441,7 @@ config GOLDFISH
 config RETPOLINE
 	bool "Avoid speculative indirect branches in kernel"
 	default y
+	depends on !IPIPE
 	select STACK_VALIDATION if HAVE_STACK_VALIDATION
 	help
 	  Compile kernel with the retpoline compiler options to guard against
@@ -462,6 +465,7 @@ config INTEL_RDT
 if X86_32
 config X86_EXTENDED_PLATFORM
 	bool "Support for extended (non-PC) x86 platforms"
+	depends on !IPIPE
 	default y
 	---help---
 	  If you disable this option then the kernel will only support
@@ -484,6 +488,7 @@ endif
 if X86_64
 config X86_EXTENDED_PLATFORM
 	bool "Support for extended (non-PC) x86 platforms"
+	depends on !IPIPE
 	default y
 	---help---
 	  If you disable this option then the kernel will only support
@@ -604,7 +609,7 @@ config X86_INTEL_QUARK
 
 config X86_INTEL_LPSS
 	bool "Intel Low Power Subsystem Support"
-	depends on X86 && ACPI
+	depends on X86 && ACPI && !IPIPE
 	select COMMON_CLK
 	select PINCTRL
 	select IOSF_MBI
@@ -730,6 +735,7 @@ config SCHED_OMIT_FRAME_POINTER
 
 menuconfig HYPERVISOR_GUEST
 	bool "Linux guest support"
+	depends on !IPIPE
 	---help---
 	  Say Y here to enable options for running Linux under various hyper-
 	  visors. This option enables basic hypervisor detection and platform
@@ -872,7 +878,7 @@ config DMI
 config GART_IOMMU
 	bool "Old AMD GART IOMMU support"
 	select SWIOTLB
-	depends on X86_64 && PCI && AMD_NB
+	depends on X86_64 && PCI && AMD_NB && !IPIPE
 	---help---
 	  Provides a driver for older AMD Athlon64/Opteron/Turion/Sempron
 	  GART based hardware IOMMUs.
@@ -893,7 +899,7 @@ config GART_IOMMU
 config CALGARY_IOMMU
 	bool "IBM Calgary IOMMU support"
 	select SWIOTLB
-	depends on X86_64 && PCI
+	depends on X86_64 && PCI && !IPIPE
 	---help---
 	  Support for hardware IOMMUs in IBM's xSeries x366 and x460
 	  systems. Needed to run systems with more than 3GB of memory
@@ -944,6 +950,7 @@ config MAXSMP
 config NR_CPUS
 	int "Maximum number of CPUs" if SMP && !MAXSMP
 	range 2 8 if SMP && X86_32 && !X86_BIGSMP
+	range 2 16 if X86_64 && IPIPE
 	range 2 64 if SMP && X86_32 && X86_BIGSMP
 	range 2 512 if SMP && !MAXSMP && !CPUMASK_OFFSTACK && X86_64
 	range 2 8192 if SMP && !MAXSMP && CPUMASK_OFFSTACK && X86_64
@@ -958,16 +965,19 @@ config NR_CPUS
 	  supported value is 8192, otherwise the maximum value is 512.  The
 	  minimum value which makes sense is 2.
 
-	  This is purely to save memory - each supported CPU adds
-	  approximately eight kilobytes to the kernel image.
+	  For IPIPE-enabled platforms, large values causes serious problems.
+	  The max limit in this case is 16.
+
+	  Each supported CPU adds approximately 8KB to the kernel image.
 
 config SCHED_SMT
 	def_bool y if SMP
+	depends on !IPIPE
 
 config SCHED_MC
 	def_bool y
 	prompt "Multi-core scheduler support"
-	depends on SMP
+	depends on SMP && !IPIPE
 	---help---
 	  Multi-core scheduler support improves the CPU scheduler's decision
 	  making when dealing with multi-core CPU chips at a cost of slightly
@@ -1124,7 +1134,7 @@ source "arch/x86/events/Kconfig"
 config X86_LEGACY_VM86
 	bool "Legacy VM86 support"
 	default n
-	depends on X86_32
+	depends on X86_32 && !IPIPE
 	---help---
 	  This option allows user programs to put the CPU into V8086
 	  mode, which is an 80286-era approximation of 16-bit real mode.
@@ -1156,7 +1166,7 @@ config VM86
 config X86_16BIT
 	bool "Enable support for 16-bit segments" if EXPERT
 	default y
-	depends on MODIFY_LDT_SYSCALL
+	depends on MODIFY_LDT_SYSCALL && !IPIPE
 	---help---
 	  This option is required by programs like Wine to run 16-bit
 	  protected mode legacy code on x86 processors.  Disabling
@@ -1174,7 +1184,7 @@ config X86_ESPFIX64
 config X86_VSYSCALL_EMULATION
        bool "Enable vsyscall emulation" if EXPERT
        default y
-       depends on X86_64
+       depends on X86_64 && !IPIPE
        ---help---
 	 This enables emulation of the legacy vsyscall page.  Disabling
 	 it is roughly equivalent to booting with vsyscall=none, except
@@ -1191,7 +1201,7 @@ config X86_VSYSCALL_EMULATION
 
 config TOSHIBA
 	tristate "Toshiba Laptop support"
-	depends on X86_32
+	depends on X86_32 && !IPIPE
 	---help---
 	  This adds a driver to safely access the System Management Mode of
 	  the CPU on Toshiba portables with a genuine Toshiba BIOS. It does
@@ -1207,6 +1217,7 @@ config TOSHIBA
 
 config I8K
 	tristate "Dell i8k legacy laptop support"
+	depends on !IPIPE
 	select HWMON
 	select SENSORS_DELL_SMM
 	---help---
@@ -1456,7 +1467,7 @@ config ARCH_HAS_MEM_ENCRYPT
 
 config AMD_MEM_ENCRYPT
 	bool "AMD Secure Memory Encryption (SME) support"
-	depends on X86_64 && CPU_SUP_AMD
+	depends on X86_64 && CPU_SUP_AMD && !IPIPE
 	---help---
 	  Say yes to enable support for the encryption of system memory.
 	  This requires an AMD processor that supports Secure Memory
@@ -1485,6 +1496,7 @@ config NUMA
 	bool "Numa Memory Allocation and Scheduler Support"
 	depends on SMP
 	depends on X86_64 || (X86_32 && HIGHMEM64G && X86_BIGSMP)
+	depends on !IPIPE
 	default y if X86_BIGSMP
 	---help---
 	  Enable NUMA (Non Uniform Memory Access) support.
@@ -1606,8 +1618,7 @@ config X86_PMEM_LEGACY_DEVICE
 
 config X86_PMEM_LEGACY
 	tristate "Support non-standard NVDIMMs and ADR protected memory"
-	depends on PHYS_ADDR_T_64BIT
-	depends on BLK_DEV
+	depends on PHYS_ADDR_T_64BIT && BLK_DEV && !IPIPE
 	select X86_PMEM_LEGACY_DEVICE
 	select LIBNVDIMM
 	help
@@ -1809,6 +1820,7 @@ config ARCH_RANDOM
 
 config X86_SMAP
 	def_bool y
+	depends on !IPIPE
 	prompt "Supervisor Mode Access Prevention" if EXPERT
 	---help---
 	  Supervisor Mode Access Prevention (SMAP) is a security
@@ -1822,7 +1834,7 @@ config X86_INTEL_MPX
 	prompt "Intel MPX (Memory Protection Extensions)"
 	def_bool n
 	# Note: only available in 64-bit mode due to VMA flags shortage
-	depends on CPU_SUP_INTEL && X86_64
+	depends on CPU_SUP_INTEL && X86_64 && !IPIPE
 	select ARCH_USES_HIGH_VMA_FLAGS
 	---help---
 	  MPX provides hardware features that can be used in
@@ -1850,7 +1862,7 @@ config X86_INTEL_MEMORY_PROTECTION_KEYS
 	prompt "Intel Memory Protection Keys"
 	def_bool y
 	# Note: only available in 64-bit mode
-	depends on CPU_SUP_INTEL && X86_64
+	depends on CPU_SUP_INTEL && X86_64 && !IPIPE
 	select ARCH_USES_HIGH_VMA_FLAGS
 	select ARCH_HAS_PKEYS
 	---help---
@@ -1909,7 +1921,7 @@ endchoice
 
 config EFI
 	bool "EFI runtime service support"
-	depends on ACPI
+	depends on ACPI && !IPIPE
 	select UCS2_STRING
 	select EFI_RUNTIME_WRAPPERS
 	---help---
@@ -1967,6 +1979,7 @@ source kernel/Kconfig.hz
 
 config KEXEC
 	bool "kexec system call"
+	depends on !IPIPE
 	select KEXEC_CORE
 	---help---
 	  kexec is a system call that implements the ability to shutdown your
@@ -1986,9 +1999,8 @@ config KEXEC_FILE
 	bool "kexec file based system call"
 	select KEXEC_CORE
 	select BUILD_BIN2C
-	depends on X86_64
-	depends on CRYPTO=y
-	depends on CRYPTO_SHA256=y
+	depends on X86_64 && CRYPTO=y && CRYPTO_SHA256=y
+	depends on !IPIPE
 	---help---
 	  This is new version of kexec system call. This system call is
 	  file based and takes file descriptors as system call argument
@@ -2017,6 +2029,7 @@ config KEXEC_BZIMAGE_VERIFY_SIG
 config CRASH_DUMP
 	bool "kernel crash dumps"
 	depends on X86_64 || (X86_32 && HIGHMEM)
+	depends on !IPIPE
 	---help---
 	  Generate crash dump after being started by kexec.
 	  This should be normally only set in special crash dump kernels
@@ -2078,6 +2091,7 @@ config PHYSICAL_START
 
 config RELOCATABLE
 	bool "Build a relocatable kernel"
+	depends on !IPIPE
 	default y
 	---help---
 	  This builds a kernel image that retains relocation information
@@ -2194,7 +2208,7 @@ config RANDOMIZE_MEMORY_PHYSICAL_PADDING
 
 config HOTPLUG_CPU
 	def_bool y
-	depends on SMP
+	depends on SMP && !IPIPE
 
 config BOOTPARAM_HOTPLUG_CPU0
 	bool "Set default setting of cpu0_hotpluggable"
@@ -2268,7 +2282,7 @@ config COMPAT_VDSO
 choice
 	prompt "vsyscall table for legacy applications"
 	depends on X86_64
-	default LEGACY_VSYSCALL_EMULATE
+	default LEGACY_VSYSCALL_NONE
 	help
 	  Legacy user code that does not know how to find the vDSO expects
 	  to be able to issue three syscalls by calling fixed addresses in
@@ -2282,10 +2296,11 @@ choice
 	  static binaries, you can say None without a performance penalty
 	  to improve security.
 
-	  If unsure, select "Emulate".
+	  If unsure, select "None".
 
 	config LEGACY_VSYSCALL_NATIVE
 		bool "Native"
+		depends on !IPIPE
 		help
 		  Actual executable code is located in the fixed vsyscall
 		  address mapping, implementing time() efficiently. Since
@@ -2295,6 +2310,7 @@ choice
 
 	config LEGACY_VSYSCALL_EMULATE
 		bool "Emulate"
+		depends on !IPIPE
 		help
 		  The kernel traps and emulates calls into the fixed
 		  vsyscall address mapping. This makes the mapping
@@ -2359,6 +2375,7 @@ config CMDLINE_OVERRIDE
 
 config MODIFY_LDT_SYSCALL
 	bool "Enable the LDT (local descriptor table)" if EXPERT
+	depends on !IPIPE
 	default y
 	---help---
 	  Linux can allow user programs to install a per-process x86
@@ -2851,7 +2868,7 @@ source "fs/Kconfig.binfmt"
 
 config IA32_EMULATION
 	bool "IA32 Emulation"
-	depends on X86_64
+	depends on X86_64 && !IPIPE
 	select ARCH_WANT_OLD_COMPAT_IPC
 	select BINFMT_ELF
 	select COMPAT_BINFMT_ELF
@@ -2869,7 +2886,7 @@ config IA32_AOUT
 
 config X86_X32
 	bool "x32 ABI for 64-bit mode"
-	depends on X86_64
+	depends on X86_64 && !IPIPE
 	---help---
 	  Include code to run binaries for the x32 native 32-bit ABI
 	  for 64-bit processors.  An x32 process gets access to the
diff --git a/arch/x86/Kconfig.debug b/arch/x86/Kconfig.debug
index bec0952c5595..96aefe9991db 100644
--- a/arch/x86/Kconfig.debug
+++ b/arch/x86/Kconfig.debug
@@ -77,7 +77,7 @@ config X86_PTDUMP_CORE
 
 config X86_PTDUMP
 	tristate "Export kernel pagetable layout to userspace via debugfs"
-	depends on DEBUG_KERNEL
+	depends on DEBUG_KERNEL && !IPIPE
 	select DEBUG_FS
 	select X86_PTDUMP_CORE
 	---help---
@@ -136,7 +136,7 @@ config DOUBLEFAULT
 
 config DEBUG_TLBFLUSH
 	bool "Set upper limit of TLB entries to flush one-by-one"
-	depends on DEBUG_KERNEL
+	depends on DEBUG_KERNEL && !IPIPE
 	---help---
 
 	X86-only for now.
@@ -155,7 +155,7 @@ config DEBUG_TLBFLUSH
 
 config IOMMU_DEBUG
 	bool "Enable IOMMU debugging"
-	depends on GART_IOMMU && DEBUG_KERNEL
+	depends on DEBUG_KERNEL && GART_IOMMU && IOMMU
 	depends on X86_64
 	---help---
 	  Force the IOMMU to on even when you have less than 4GB of
@@ -171,6 +171,7 @@ config IOMMU_DEBUG
 
 config IOMMU_STRESS
 	bool "Enable IOMMU stress-test mode"
+	depends on IOMMU_DEBUG
 	---help---
 	  This option disables various optimizations in IOMMU related
 	  code to do real stress testing of the IOMMU code. This option
@@ -189,7 +190,7 @@ config HAVE_MMIOTRACE_SUPPORT
 
 config X86_DECODER_SELFTEST
 	bool "x86 instruction decoder selftest"
-	depends on DEBUG_KERNEL && INSTRUCTION_DECODER
+	depends on DEBUG_KERNEL && INSTRUCTION_DECODER && !IPIPE
 	depends on !COMPILE_TEST
 	---help---
 	 Perform x86 instruction decoder selftests at build time.
@@ -219,10 +220,10 @@ config IO_DELAY_TYPE_NONE
 
 choice
 	prompt "IO delay type"
-	default IO_DELAY_0X80
+	default IO_DELAY_NONE
 
 config IO_DELAY_0X80
-	bool "port 0x80 based port-IO delay [recommended]"
+	bool "port 0x80 based port-IO delay"
 	---help---
 	  This is the traditional Linux IO delay used for in/out_p.
 	  It is the most tested hence safest selection here.
@@ -240,7 +241,7 @@ config IO_DELAY_UDELAY
 	  while not having any side-effect on the IO port space.
 
 config IO_DELAY_NONE
-	bool "no port-IO delay"
+	bool "no port-IO delay [recommended]"
 	---help---
 	  No port-IO delay. Will break on old boxes that require port-IO
 	  delay for certain operations. Should work on most new machines.
@@ -273,14 +274,13 @@ endif
 
 config DEBUG_BOOT_PARAMS
 	bool "Debug boot parameters"
-	depends on DEBUG_KERNEL
-	depends on DEBUG_FS
+	depends on DEBUG_KERNEL && DEBUG_FS && !IPIPE
 	---help---
 	  This option will cause struct boot_params to be exported via debugfs.
 
 config CPA_DEBUG
 	bool "CPA self-test code"
-	depends on DEBUG_KERNEL
+	depends on DEBUG_KERNEL && !IPIPE
 	---help---
 	  Do change_page_attr() self-tests every 30 seconds.
 
@@ -300,7 +300,7 @@ config OPTIMIZE_INLINING
 
 config DEBUG_ENTRY
 	bool "Debug low-level entry code"
-	depends on DEBUG_KERNEL
+	depends on DEBUG_KERNEL && !IPIPE
 	---help---
 	  This option enables sanity checks in x86's low-level entry code.
 	  Some of these sanity checks may slow down kernel entries and
@@ -335,7 +335,7 @@ config DEBUG_IMR_SELFTEST
 
 config X86_DEBUG_FPU
 	bool "Debug the x86 FPU code"
-	depends on DEBUG_KERNEL
+	depends on DEBUG_KERNEL && !IPIPE
 	default y
 	---help---
 	  If this option is enabled then there will be extra sanity
@@ -347,7 +347,7 @@ config X86_DEBUG_FPU
 
 config PUNIT_ATOM_DEBUG
 	tristate "ATOM Punit debug driver"
-	depends on PCI
+	depends on PCI && !IPIPE
 	select DEBUG_FS
 	select IOSF_MBI
 	---help---
@@ -359,8 +359,7 @@ config PUNIT_ATOM_DEBUG
 
 choice
 	prompt "Choose kernel unwinder"
-	default UNWINDER_ORC if X86_64
-	default UNWINDER_FRAME_POINTER if X86_32
+	default UNWINDER_GUESS
 	---help---
 	  This determines which method will be used for unwinding kernel stack
 	  traces for panics, oopses, bugs, warnings, perf, /proc/<pid>/stack,
@@ -368,7 +367,7 @@ choice
 
 config UNWINDER_ORC
 	bool "ORC unwinder"
-	depends on X86_64
+	depends on X86_64 && !IPIPE
 	select STACK_VALIDATION
 	---help---
 	  This option enables the ORC (Oops Rewind Capability) unwinder for
@@ -384,6 +383,7 @@ config UNWINDER_ORC
 
 config UNWINDER_FRAME_POINTER
 	bool "Frame pointer unwinder"
+	depends on !IPIPE
 	select FRAME_POINTER
 	---help---
 	  This option enables the frame pointer unwinder for unwinding kernel
@@ -399,7 +399,6 @@ config UNWINDER_FRAME_POINTER
 
 config UNWINDER_GUESS
 	bool "Guess unwinder"
-	depends on EXPERT
 	---help---
 	  This option enables the "guess" unwinder for unwinding kernel stack
 	  traces.  It scans the stack and reports every kernel text address it
diff --git a/arch/x86/events/Kconfig b/arch/x86/events/Kconfig
index 9a7a1446cb3a..ddcb4d1ecb9a 100644
--- a/arch/x86/events/Kconfig
+++ b/arch/x86/events/Kconfig
@@ -1,5 +1,6 @@
 # SPDX-License-Identifier: GPL-2.0
 menu "Performance monitoring"
+	depends on !IPIPE
 
 config PERF_EVENTS_INTEL_UNCORE
 	tristate "Intel uncore performance events"
diff --git a/arch/x86/kvm/Kconfig b/arch/x86/kvm/Kconfig
index 3df51c287844..4971a5b221ac 100644
--- a/arch/x86/kvm/Kconfig
+++ b/arch/x86/kvm/Kconfig
@@ -8,6 +8,7 @@ source "virt/kvm/Kconfig"
 menuconfig VIRTUALIZATION
 	bool "Virtualization"
 	depends on HAVE_KVM || X86
+	depends on !IPIPE
 	default y
 	---help---
 	  Say Y here to get to see options for using your Linux host to run other
diff --git a/drivers/acpi/Kconfig b/drivers/acpi/Kconfig
index 5b1938f4b626..79030050bcca 100644
--- a/drivers/acpi/Kconfig
+++ b/drivers/acpi/Kconfig
@@ -60,6 +60,7 @@ config ACPI_CCA_REQUIRED
 
 config ACPI_DEBUGGER
 	bool "AML debugger interface"
+	depends on !IPIPE
 	select ACPI_DEBUG
 	help
 	  Enable in-kernel debugging of AML facilities: statistics,
@@ -126,6 +127,7 @@ config ACPI_REV_OVERRIDE_POSSIBLE
 
 config ACPI_EC_DEBUGFS
 	tristate "EC read/write access through /sys/kernel/debug/ec"
+	depends on !IPIPE
 	default n
 	help
 	  Say N to disable Embedded Controller /sys/kernel/debug interface
@@ -144,7 +146,7 @@ config ACPI_EC_DEBUGFS
 
 config ACPI_AC
 	tristate "AC Adapter"
-	depends on X86
+	depends on X86 && !IPIPE
 	select POWER_SUPPLY
 	default y
 	help
@@ -157,7 +159,7 @@ config ACPI_AC
 
 config ACPI_BATTERY
 	tristate "Battery"
-	depends on X86
+	depends on X86 && !IPIPE
 	select POWER_SUPPLY
 	default y
 	help
@@ -209,6 +211,7 @@ config ACPI_FAN
 
 config ACPI_DOCK
 	bool "Dock"
+	depends on !IPIPE
 	help
 	  This driver supports ACPI-controlled docking stations and removable
 	  drive bays such as the IBM Ultrabay and the Dell Module Bay.
@@ -243,6 +246,7 @@ config ACPI_CPPC_LIB
 
 config ACPI_PROCESSOR
 	tristate "Processor"
+	depends on !IPIPE
 	depends on X86 || IA64 || ARM64
 	select ACPI_PROCESSOR_IDLE
 	select ACPI_CPU_FREQ_PSS if X86 || IA64
@@ -301,7 +305,7 @@ config ACPI_THERMAL
 config ACPI_NUMA
 	bool "NUMA support"
 	depends on NUMA
-	depends on (X86 || IA64 || ARM64)
+	depends on (X86 || IA64 || ARM64) && !IPIPE
 	default y if IA64_GENERIC || IA64_SGI_SN2 || ARM64
 
 config ACPI_CUSTOM_DSDT_FILE
@@ -336,6 +340,7 @@ config ACPI_TABLE_UPGRADE
 
 config ACPI_DEBUG
 	bool "Debug Statements"
+	depends on !IPIPE
 	default n
 	help
 	  The ACPI subsystem can produce debug output.  Saying Y enables this
@@ -348,7 +353,7 @@ config ACPI_DEBUG
 
 config ACPI_PCI_SLOT
 	bool "PCI slot detection driver"
-	depends on SYSFS
+	depends on SYSFS && !IPIPE
 	default n
 	help
 	  This driver creates entries in /sys/bus/pci/slots/ for all PCI
@@ -374,7 +379,7 @@ config X86_PM_TIMER
 
 config ACPI_CONTAINER
 	bool "Container and Module Devices"
-	default (ACPI_HOTPLUG_MEMORY || ACPI_HOTPLUG_CPU)
+	depends on (ACPI_HOTPLUG_MEMORY || ACPI_HOTPLUG_CPU)
 	help
 	  This driver supports ACPI Container and Module devices (IDs
 	  ACPI0004, PNP0A05, and PNP0A06).
@@ -408,7 +413,7 @@ config ACPI_HOTPLUG_IOAPIC
 
 config ACPI_SBS
 	tristate "Smart Battery System"
-	depends on X86
+	depends on X86 && !IPIPE
 	select POWER_SUPPLY
 	help
 	  This driver supports the Smart Battery System, another
@@ -419,6 +424,7 @@ config ACPI_SBS
 
 config ACPI_HED
 	tristate "Hardware Error Device"
+	depends on !IPIPE
 	help
 	  This driver supports the Hardware Error Device (PNP0C33),
 	  which is used to report some hardware errors notified via
@@ -426,7 +432,7 @@ config ACPI_HED
 
 config ACPI_CUSTOM_METHOD
 	tristate "Allow ACPI methods to be inserted/replaced at run time"
-	depends on DEBUG_FS
+	depends on DEBUG_FS && !IPIPE
 	default n
 	help
 	  This debug facility allows ACPI AML methods to be inserted and/or
@@ -441,7 +447,7 @@ config ACPI_CUSTOM_METHOD
 
 config ACPI_BGRT
 	bool "Boottime Graphics Resource Table support"
-	depends on EFI && (X86 || ARM64)
+	depends on EFI && (X86 || ARM64) && !IPIPE
         help
 	  This driver adds support for exposing the ACPI Boottime Graphics
 	  Resource Table, which allows the operating system to obtain
@@ -470,7 +476,7 @@ config ACPI_WATCHDOG
 
 config ACPI_EXTLOG
 	tristate "Extended Error Log support"
-	depends on X86_MCE && X86_LOCAL_APIC && EDAC
+	depends on X86_MCE && X86_LOCAL_APIC && EDAC && !IPIPE
 	select UEFI_CPER
 	default n
 	help
@@ -491,6 +497,7 @@ config ACPI_EXTLOG
 
 menuconfig PMIC_OPREGION
 	bool "PMIC (Power Management Integrated Circuit) operation region support"
+	depends on !IPIPE
 	help
 	  Select this option to enable support for ACPI operation
 	  region of the PMIC chip. The operation region can be used
@@ -526,6 +533,7 @@ endif
 
 config ACPI_CONFIGFS
 	tristate "ACPI configfs support"
+	depends on !IPIPE
 	select CONFIGFS_FS
 	help
 	  Select this option to enable support for ACPI configuration from
diff --git a/drivers/acpi/apei/Kconfig b/drivers/acpi/apei/Kconfig
index 52ae5438edeb..a871a3f546ae 100644
--- a/drivers/acpi/apei/Kconfig
+++ b/drivers/acpi/apei/Kconfig
@@ -10,7 +10,7 @@ config ACPI_APEI
 	select MISC_FILESYSTEMS
 	select PSTORE
 	select UEFI_CPER
-	depends on HAVE_ACPI_APEI
+	depends on HAVE_ACPI_APEI && !IPIPE
 	help
 	  APEI allows to report errors (for example from the chipset)
 	  to the operating system. This improves NMI handling
diff --git a/drivers/acpi/dptf/Kconfig b/drivers/acpi/dptf/Kconfig
index 90a2fd979282..bc4189889638 100644
--- a/drivers/acpi/dptf/Kconfig
+++ b/drivers/acpi/dptf/Kconfig
@@ -1,7 +1,7 @@
 # SPDX-License-Identifier: GPL-2.0
 config DPTF_POWER
 	tristate "DPTF Platform Power Participant"
-	depends on X86
+	depends on X86 && !IPIPE
 	help
 	  This driver adds support for Dynamic Platform and Thermal Framework
 	  (DPTF) Platform Power Participant device (INT3407) support.
diff --git a/drivers/acpi/nfit/Kconfig b/drivers/acpi/nfit/Kconfig
index f7c57e33499e..1c32def97b0d 100644
--- a/drivers/acpi/nfit/Kconfig
+++ b/drivers/acpi/nfit/Kconfig
@@ -4,6 +4,7 @@ config ACPI_NFIT
 	depends on PHYS_ADDR_T_64BIT
 	depends on BLK_DEV
 	depends on ARCH_HAS_PMEM_API
+	depends on !IPIPE
 	select LIBNVDIMM
 	help
 	  Infrastructure to probe ACPI 6 compliant platforms for
diff --git a/drivers/bus/Kconfig b/drivers/bus/Kconfig
index 3e66f4cc1a59..de575d012f79 100644
--- a/drivers/bus/Kconfig
+++ b/drivers/bus/Kconfig
@@ -4,6 +4,7 @@
 #
 
 menu "Bus devices"
+	depends on !IPIPE
 
 config ARM_CCI
 	bool
diff --git a/drivers/char/ipmi/Kconfig b/drivers/char/ipmi/Kconfig
index f6fa056a52fc..764e68bf93b8 100644
--- a/drivers/char/ipmi/Kconfig
+++ b/drivers/char/ipmi/Kconfig
@@ -4,7 +4,7 @@
 
 menuconfig IPMI_HANDLER
        tristate 'IPMI top-level message handler'
-       depends on HAS_IOMEM
+       depends on HAS_IOMEM && !IPIPE
        select IPMI_DMI_DECODE if DMI
        help
          This enables the central IPMI message handler, required for IPMI
diff --git a/drivers/char/tpm/Kconfig b/drivers/char/tpm/Kconfig
index a30352202f1f..5a43a6a2877b 100644
--- a/drivers/char/tpm/Kconfig
+++ b/drivers/char/tpm/Kconfig
@@ -4,7 +4,7 @@
 
 menuconfig TCG_TPM
 	tristate "TPM Hardware Support"
-	depends on HAS_IOMEM
+	depends on HAS_IOMEM && !IPIPE
 	select SECURITYFS
 	select CRYPTO
 	select CRYPTO_HASH_INFO
diff --git a/drivers/clk/Kconfig b/drivers/clk/Kconfig
index 1c4e1aa6767e..e11a60f90c6e 100644
--- a/drivers/clk/Kconfig
+++ b/drivers/clk/Kconfig
@@ -20,7 +20,7 @@ config COMMON_CLK
 	  this option.
 
 menu "Common Clock Framework"
-	depends on COMMON_CLK
+	depends on COMMON_CLK && !IPIPE
 
 config COMMON_CLK_WM831X
 	tristate "Clock driver for WM831x/2x PMICs"
diff --git a/drivers/clocksource/Kconfig b/drivers/clocksource/Kconfig
index cc6062049170..ba1c2f4613de 100644
--- a/drivers/clocksource/Kconfig
+++ b/drivers/clocksource/Kconfig
@@ -1,5 +1,15 @@
+
+config CLKEVT_I8253
+	bool
+
+config I8253_LOCK
+	bool
+
+config CLKBLD_I8253
+	def_bool y if CLKSRC_I8253 || CLKEVT_I8253 || I8253_LOCK
+
 menu "Clock Source drivers"
-	depends on !ARCH_USES_GETTIMEOFFSET
+	depends on !ARCH_USES_GETTIMEOFFSET && !IPIPE
 
 config TIMER_OF
 	bool
@@ -16,15 +26,6 @@ config TIMER_PROBE
 config CLKSRC_I8253
 	bool
 
-config CLKEVT_I8253
-	bool
-
-config I8253_LOCK
-	bool
-
-config CLKBLD_I8253
-	def_bool y if CLKSRC_I8253 || CLKEVT_I8253 || I8253_LOCK
-
 config CLKSRC_MMIO
 	bool
 
diff --git a/drivers/cpufreq/Kconfig b/drivers/cpufreq/Kconfig
index d8addbce40bc..a1ee653fe505 100644
--- a/drivers/cpufreq/Kconfig
+++ b/drivers/cpufreq/Kconfig
@@ -1,4 +1,5 @@
 menu "CPU Frequency scaling"
+	depends on !IPIPE
 
 config CPU_FREQ
 	bool "CPU Frequency scaling"
diff --git a/drivers/cpuidle/Kconfig b/drivers/cpuidle/Kconfig
index 7e48eb5bf0a7..c2ea48faae46 100644
--- a/drivers/cpuidle/Kconfig
+++ b/drivers/cpuidle/Kconfig
@@ -1,4 +1,5 @@
 menu "CPU Idle"
+depends on !IPIPE
 
 config CPU_IDLE
 	bool "CPU idle PM support"
diff --git a/drivers/crypto/Kconfig b/drivers/crypto/Kconfig
index 342bc777841c..0b22296d716e 100644
--- a/drivers/crypto/Kconfig
+++ b/drivers/crypto/Kconfig
@@ -1,6 +1,7 @@
 
 menuconfig CRYPTO_HW
 	bool "Hardware crypto devices"
+	depends on !IPIPE
 	default y
 	---help---
 	  Say Y here to get to see options for hardware crypto devices and
diff --git a/drivers/devfreq/Kconfig b/drivers/devfreq/Kconfig
index 4c4ec68b0566..dcc12c2f8448 100644
--- a/drivers/devfreq/Kconfig
+++ b/drivers/devfreq/Kconfig
@@ -1,5 +1,6 @@
 menuconfig PM_DEVFREQ
 	bool "Generic Dynamic Voltage and Frequency Scaling (DVFS) support"
+	depends on !IPIPE
 	select SRCU
 	select PM_OPP
 	help
diff --git a/drivers/firmware/Kconfig b/drivers/firmware/Kconfig
index 42c4ff75281b..05762eeeabb2 100644
--- a/drivers/firmware/Kconfig
+++ b/drivers/firmware/Kconfig
@@ -186,7 +186,7 @@ config RASPBERRYPI_FIRMWARE
 config FW_CFG_SYSFS
 	tristate "QEMU fw_cfg device support in sysfs"
 	depends on SYSFS && (ARM || ARM64 || PPC_PMAC || SPARC || X86)
-	depends on HAS_IOPORT_MAP
+	depends on HAS_IOPORT_MAP && !IPIPE
 	default n
 	help
 	  Say Y or M here to enable the exporting of the QEMU firmware
diff --git a/drivers/firmware/tegra/Kconfig b/drivers/firmware/tegra/Kconfig
index ff2730d5c468..4cc867d3fe25 100644
--- a/drivers/firmware/tegra/Kconfig
+++ b/drivers/firmware/tegra/Kconfig
@@ -1,4 +1,5 @@
 menu "Tegra firmware driver"
+	depends on !IPIPE
 
 config TEGRA_IVC
 	bool "Tegra IVC protocol"
diff --git a/drivers/fsi/Kconfig b/drivers/fsi/Kconfig
index 6821ed0cd5e8..23561e25b594 100644
--- a/drivers/fsi/Kconfig
+++ b/drivers/fsi/Kconfig
@@ -3,6 +3,7 @@
 #
 
 menu "FSI support"
+	depends on !IPIPE
 
 config FSI
 	tristate "FSI support"
diff --git a/drivers/gpu/drm/i915/Kconfig b/drivers/gpu/drm/i915/Kconfig
index e9e64e8e9765..57f14648f644 100644
--- a/drivers/gpu/drm/i915/Kconfig
+++ b/drivers/gpu/drm/i915/Kconfig
@@ -96,6 +96,7 @@ config DRM_I915_GVT
         bool "Enable Intel GVT-g graphics virtualization host support"
         depends on DRM_I915
         depends on 64BIT
+        depends on !IPIPE
         default n
         help
 	  Choose this option if you want to enable Intel GVT-g graphics
@@ -128,5 +129,6 @@ config DRM_I915_GVT_KVMGT
 menu "drm/i915 Debugging"
 depends on DRM_I915
 depends on EXPERT
+depends on !IPIPE
 source drivers/gpu/drm/i915/Kconfig.debug
 endmenu
diff --git a/drivers/gpu/drm/nouveau/Kconfig b/drivers/gpu/drm/nouveau/Kconfig
index a0c0630a0857..8542bef4802c 100644
--- a/drivers/gpu/drm/nouveau/Kconfig
+++ b/drivers/gpu/drm/nouveau/Kconfig
@@ -42,14 +42,15 @@ config NOUVEAU_PLATFORM_DRIVER
 config NOUVEAU_DEBUG
 	int "Maximum debug level"
 	depends on DRM_NOUVEAU
-	range 0 7
-	default 5
+	range 0 7 if !IPIPE
+	range 0 2 if IPIPE
+	default 2
 	help
 	  Selects the maximum debug level to compile support for.
 
 	  0 - fatal
 	  1 - error
-	  2 - warning
+	  2 - warning (maximum if IPIPE enabled)
 	  3 - info
 	  4 - debug
 	  5 - trace (recommended)
@@ -62,8 +63,9 @@ config NOUVEAU_DEBUG
 config NOUVEAU_DEBUG_DEFAULT
 	int "Default debug level"
 	depends on DRM_NOUVEAU
-	range 0 7
-	default 3
+	range 0 7 if !IPIPE
+	range 0 2 if IPIPE
+	default 1
 	help
 	  Selects the default debug level
 
diff --git a/drivers/hv/Kconfig b/drivers/hv/Kconfig
index 247a62604d1f..d6858497460a 100644
--- a/drivers/hv/Kconfig
+++ b/drivers/hv/Kconfig
@@ -1,4 +1,5 @@
 menu "Microsoft Hyper-V guest support"
+	depends on !IPIPE
 
 config HYPERV
 	tristate "Microsoft Hyper-V client drivers"
diff --git a/drivers/hwspinlock/Kconfig b/drivers/hwspinlock/Kconfig
index 6e0a5539a9ea..91fd47ae4c29 100644
--- a/drivers/hwspinlock/Kconfig
+++ b/drivers/hwspinlock/Kconfig
@@ -4,6 +4,7 @@
 
 menuconfig HWSPINLOCK
 	tristate "Hardware Spinlock drivers"
+	depends on !IPIPE
 
 config HWSPINLOCK_OMAP
 	tristate "OMAP Hardware Spinlock device"
diff --git a/drivers/i2c/Kconfig b/drivers/i2c/Kconfig
index efc3354d60ae..f64ed101a997 100644
--- a/drivers/i2c/Kconfig
+++ b/drivers/i2c/Kconfig
@@ -26,7 +26,7 @@ config I2C
 
 config ACPI_I2C_OPREGION
 	bool "ACPI I2C Operation region support"
-	depends on I2C=y && ACPI
+	depends on I2C=y && ACPI && !IPIPE
 	default y
 	help
 	  Say Y here if you want to enable ACPI I2C operation region support.
diff --git a/drivers/infiniband/hw/usnic/Kconfig b/drivers/infiniband/hw/usnic/Kconfig
index 29ab11c34f3f..b59ea9838e9c 100644
--- a/drivers/infiniband/hw/usnic/Kconfig
+++ b/drivers/infiniband/hw/usnic/Kconfig
@@ -1,6 +1,7 @@
 config INFINIBAND_USNIC
 	tristate "Verbs support for Cisco VIC"
 	depends on NETDEVICES && ETHERNET && INET && PCI && INTEL_IOMMU
+	depends on !IPIPE
 	select ENIC
 	select NET_VENDOR_CISCO
 	select PCI_IOV
diff --git a/drivers/iommu/Kconfig b/drivers/iommu/Kconfig
index f3a21343e636..1e1ec7c3f97f 100644
--- a/drivers/iommu/Kconfig
+++ b/drivers/iommu/Kconfig
@@ -4,7 +4,7 @@ config IOMMU_API
 
 menuconfig IOMMU_SUPPORT
 	bool "IOMMU Hardware Support"
-	depends on MMU
+	depends on MMU && !IPIPE
 	default y
 	---help---
 	  Say Y here if you want to compile device drivers for IO Memory
diff --git a/drivers/mailbox/Kconfig b/drivers/mailbox/Kconfig
index c5731e5e3c6c..856e16ab82a9 100644
--- a/drivers/mailbox/Kconfig
+++ b/drivers/mailbox/Kconfig
@@ -1,5 +1,6 @@
 menuconfig MAILBOX
 	bool "Mailbox Hardware Support"
+	depends on !IPIPE
 	help
 	  Mailbox is a framework to control hardware communication between
 	  on-chip processors through queued messages and interrupt driven
diff --git a/drivers/misc/mic/Kconfig b/drivers/misc/mic/Kconfig
index 6fd9d367dea7..15c64ae8506e 100644
--- a/drivers/misc/mic/Kconfig
+++ b/drivers/misc/mic/Kconfig
@@ -130,9 +130,8 @@ comment "VOP Driver"
 
 config VOP
 	tristate "VOP Driver"
-	depends on 64BIT && PCI && X86 && VOP_BUS
+	depends on 64BIT && PCI && X86 && VOP_BUS && VIRTIO
 	select VHOST_RING
-	select VIRTIO
 	help
 	  This enables VOP (Virtio over PCIe) Driver support for the Intel
 	  Many Integrated Core (MIC) family of PCIe form factor coprocessor
diff --git a/drivers/misc/vmw_vmci/Kconfig b/drivers/misc/vmw_vmci/Kconfig
index 39c2ecadb273..34de99aff944 100644
--- a/drivers/misc/vmw_vmci/Kconfig
+++ b/drivers/misc/vmw_vmci/Kconfig
@@ -4,7 +4,7 @@
 
 config VMWARE_VMCI
 	tristate "VMware VMCI Driver"
-	depends on X86 && PCI
+	depends on X86 && PCI && !IPIPE
 	help
 	  This is VMware's Virtual Machine Communication Interface.  It enables
 	  high-speed communication between host and guest in a virtual
diff --git a/drivers/net/caif/Kconfig b/drivers/net/caif/Kconfig
index f81df91a9ce1..7b38ada49c0c 100644
--- a/drivers/net/caif/Kconfig
+++ b/drivers/net/caif/Kconfig
@@ -43,9 +43,8 @@ config CAIF_HSI
 
 config CAIF_VIRTIO
 	tristate "CAIF virtio transport driver"
-	depends on CAIF && HAS_DMA
+	depends on CAIF && HAS_DMA && VIRTIO
 	select VHOST_RING
-	select VIRTIO
 	select GENERIC_ALLOCATOR
 	default n
 	---help---
diff --git a/drivers/of/Kconfig b/drivers/of/Kconfig
index 6b8646db110c..346d510622eb 100644
--- a/drivers/of/Kconfig
+++ b/drivers/of/Kconfig
@@ -3,6 +3,7 @@ config DTC
 
 menuconfig OF
 	bool "Device Tree and Open Firmware support"
+	depends on !IPIPE
 	help
 	  This option enables the device tree infrastructure.
 	  It is automatically selected by platforms that need it or can
diff --git a/drivers/pci/Kconfig b/drivers/pci/Kconfig
index c32a77fc8b03..47ed14a3aeaf 100644
--- a/drivers/pci/Kconfig
+++ b/drivers/pci/Kconfig
@@ -41,7 +41,7 @@ config PCI_DEBUG
 
 config PCI_REALLOC_ENABLE_AUTO
 	bool "Enable PCI resource re-allocation detection"
-	depends on PCI
+	depends on PCI && !IPIPE
 	help
 	  Say Y here if you want the PCI core to detect if PCI resource
 	  re-allocation needs to be enabled. You can always use pci=realloc=on
@@ -91,7 +91,7 @@ config PCI_LOCKLESS_CONFIG
 
 config PCI_IOV
 	bool "PCI IOV support"
-	depends on PCI
+	depends on PCI && !IPIPE
 	select PCI_ATS
 	help
 	  I/O Virtualization is a PCI feature supported by some devices
@@ -102,7 +102,7 @@ config PCI_IOV
 
 config PCI_PRI
 	bool "PCI PRI support"
-	depends on PCI
+	depends on PCI && !IPIPE
 	select PCI_ATS
 	help
 	  PRI is the PCI Page Request Interface. It allows PCI devices that are
@@ -112,7 +112,7 @@ config PCI_PRI
 
 config PCI_PASID
 	bool "PCI PASID support"
-	depends on PCI
+	depends on PCI && !IPIPE
 	select PCI_ATS
 	help
 	  Process Address Space Identifiers (PASIDs) can be used by PCI devices
@@ -130,6 +130,7 @@ config PCI_LABEL
 config PCI_HYPERV
         tristate "Hyper-V PCI Frontend"
         depends on PCI && X86 && HYPERV && PCI_MSI && PCI_MSI_IRQ_DOMAIN && X86_64
+        depends on !IPIPE
         help
           The PCI device frontend driver allows the kernel to import arbitrary
           PCI devices from a PCI backend to support PCI driver domains.
diff --git a/drivers/pci/hotplug/Kconfig b/drivers/pci/hotplug/Kconfig
index aadce45a9b4a..6d6caf6f0c38 100644
--- a/drivers/pci/hotplug/Kconfig
+++ b/drivers/pci/hotplug/Kconfig
@@ -4,7 +4,7 @@
 
 menuconfig HOTPLUG_PCI
 	bool "Support for PCI Hotplug"
-	depends on PCI && SYSFS
+	depends on PCI && SYSFS && !IPIPE
 	---help---
 	  Say Y here if you have a motherboard with a PCI Hotplug controller.
 	  This allows you to add and remove PCI cards while the machine is
diff --git a/drivers/pci/pcie/Kconfig b/drivers/pci/pcie/Kconfig
index ac53edbc9613..8268928edb4b 100644
--- a/drivers/pci/pcie/Kconfig
+++ b/drivers/pci/pcie/Kconfig
@@ -3,7 +3,7 @@
 #
 config PCIEPORTBUS
 	bool "PCI Express Port Bus support"
-	depends on PCI
+	depends on PCI && !IPIPE
 	help
 	  This automatically enables PCI Express Port Bus support. Users can
 	  choose Native Hot-Plug support, Advanced Error Reporting support,
diff --git a/drivers/perf/Kconfig b/drivers/perf/Kconfig
index e5197ffb7422..1cb176f55d5d 100644
--- a/drivers/perf/Kconfig
+++ b/drivers/perf/Kconfig
@@ -3,7 +3,7 @@
 #
 
 menu "Performance monitor support"
-	depends on PERF_EVENTS
+	depends on PERF_EVENTS && !IPIPE
 
 config ARM_PMU
 	depends on ARM || ARM64
diff --git a/drivers/pinctrl/Kconfig b/drivers/pinctrl/Kconfig
index a73c794bed03..83e3802045d7 100644
--- a/drivers/pinctrl/Kconfig
+++ b/drivers/pinctrl/Kconfig
@@ -6,7 +6,7 @@ config PINCTRL
 	bool
 
 menu "Pin controllers"
-	depends on PINCTRL
+	depends on PINCTRL && !IPIPE
 
 config GENERIC_PINCTRL_GROUPS
 	bool
diff --git a/drivers/power/avs/Kconfig b/drivers/power/avs/Kconfig
index a67eeace6a89..5d2d8bc3653d 100644
--- a/drivers/power/avs/Kconfig
+++ b/drivers/power/avs/Kconfig
@@ -1,5 +1,6 @@
 menuconfig POWER_AVS
 	bool "Adaptive Voltage Scaling class support"
+	depends on !IPIPE
 	help
 	  AVS is a power management technique which finely controls the
 	  operating voltage of a device in order to optimize (i.e. reduce)
diff --git a/drivers/power/reset/Kconfig b/drivers/power/reset/Kconfig
index ca0de1a78e85..6b1312d9d1f9 100644
--- a/drivers/power/reset/Kconfig
+++ b/drivers/power/reset/Kconfig
@@ -1,5 +1,6 @@
 menuconfig POWER_RESET
 	bool "Board level reset or power off"
+	depends on !IPIPE
 	help
 	  Provides a number of drivers which either reset a complete board
 	  or shut it down, by manipulating the main power supply on the board.
diff --git a/drivers/powercap/Kconfig b/drivers/powercap/Kconfig
index 85727ef6ce8e..196119270fde 100644
--- a/drivers/powercap/Kconfig
+++ b/drivers/powercap/Kconfig
@@ -4,6 +4,7 @@
 
 menuconfig POWERCAP
 	bool "Generic powercap sysfs driver"
+	depends on !IPIPE
 	help
 	  The power capping sysfs interface allows kernel subsystems to expose power
 	  capping settings to user space in a consistent way.  Usually, it consists
diff --git a/drivers/pwm/Kconfig b/drivers/pwm/Kconfig
index 763ee50ea57d..11a1fb3e8def 100644
--- a/drivers/pwm/Kconfig
+++ b/drivers/pwm/Kconfig
@@ -1,5 +1,6 @@
 menuconfig PWM
 	bool "Pulse-Width Modulation (PWM) Support"
+	depends on !IPIPE
 	help
 	  Generic Pulse-Width Modulation (PWM) support.
 
diff --git a/drivers/regulator/Kconfig b/drivers/regulator/Kconfig
index 0fd6195601ba..0d08d64b1718 100644
--- a/drivers/regulator/Kconfig
+++ b/drivers/regulator/Kconfig
@@ -1,5 +1,6 @@
 menuconfig REGULATOR
 	bool "Voltage and Current Regulator Support"
+	depends on !IPIPE
 	help
 	  Generic Voltage and Current Regulator support.
 
diff --git a/drivers/remoteproc/Kconfig b/drivers/remoteproc/Kconfig
index bf04479456a0..9978d103b7b7 100644
--- a/drivers/remoteproc/Kconfig
+++ b/drivers/remoteproc/Kconfig
@@ -1,11 +1,11 @@
 menu "Remoteproc drivers"
+	depends on !IPIPE
 
 config REMOTEPROC
 	tristate "Support for Remote Processor subsystem"
-	depends on HAS_DMA
+	depends on HAS_DMA && VIRTIO
 	select CRC32
 	select FW_LOADER
-	select VIRTIO
 	help
 	  Support for remote processors (such as DSP coprocessors). These
 	  are mainly used on embedded systems.
diff --git a/drivers/reset/Kconfig b/drivers/reset/Kconfig
index e2baecbb9dd3..8f5c51c2e30a 100644
--- a/drivers/reset/Kconfig
+++ b/drivers/reset/Kconfig
@@ -3,7 +3,7 @@ config ARCH_HAS_RESET_CONTROLLER
 
 menuconfig RESET_CONTROLLER
 	bool "Reset Controller Support"
-	default y if ARCH_HAS_RESET_CONTROLLER
+	default y if ARCH_HAS_RESET_CONTROLLER && !IPIPE
 	help
 	  Generic Reset Controller support.
 
diff --git a/drivers/rpmsg/Kconfig b/drivers/rpmsg/Kconfig
index 0fe6eac46512..4eff9802b4ae 100644
--- a/drivers/rpmsg/Kconfig
+++ b/drivers/rpmsg/Kconfig
@@ -1,4 +1,5 @@
 menu "Rpmsg drivers"
+depends on !IPIPE
 
 # RPMSG always gets selected by whoever wants it
 config RPMSG
@@ -48,7 +49,7 @@ config RPMSG_QCOM_SMD
 
 config RPMSG_VIRTIO
 	tristate
+	depends on VIRTIO
 	select RPMSG
-	select VIRTIO
 
 endmenu
diff --git a/drivers/scsi/ufs/Kconfig b/drivers/scsi/ufs/Kconfig
index e27b4d4e6ae2..1b6017170e58 100644
--- a/drivers/scsi/ufs/Kconfig
+++ b/drivers/scsi/ufs/Kconfig
@@ -34,7 +34,7 @@
 
 config SCSI_UFSHCD
 	tristate "Universal Flash Storage Controller Driver Core"
-	depends on SCSI && SCSI_DMA
+	depends on SCSI && SCSI_DMA && !IPIPE
 	select PM_DEVFREQ
 	select DEVFREQ_GOV_SIMPLE_ONDEMAND
 	select NLS
diff --git a/drivers/soc/Kconfig b/drivers/soc/Kconfig
index fc9e98047421..b65574cdd0d1 100644
--- a/drivers/soc/Kconfig
+++ b/drivers/soc/Kconfig
@@ -1,4 +1,5 @@
 menu "SOC (System On Chip) specific Drivers"
+	depends on !IPIPE
 
 source "drivers/soc/actions/Kconfig"
 source "drivers/soc/amlogic/Kconfig"
diff --git a/drivers/virt/Kconfig b/drivers/virt/Kconfig
index 99ebdde590f8..61e7cdb69899 100644
--- a/drivers/virt/Kconfig
+++ b/drivers/virt/Kconfig
@@ -4,6 +4,7 @@
 
 menuconfig VIRT_DRIVERS
 	bool "Virtualization drivers"
+	depends on !IPIPE
 	---help---
 	  Say Y here to get to see options for device drivers that support
 	  virtualization environments.
diff --git a/drivers/virtio/Kconfig b/drivers/virtio/Kconfig
index cff773f15b7e..5bea7c3ca9f4 100644
--- a/drivers/virtio/Kconfig
+++ b/drivers/virtio/Kconfig
@@ -1,11 +1,13 @@
 config VIRTIO
 	tristate
+	depends on !IPIPE
 	---help---
 	  This option is selected by any driver which implements the virtio
 	  bus, such as CONFIG_VIRTIO_PCI, CONFIG_VIRTIO_MMIO, CONFIG_RPMSG
 	  or CONFIG_S390_GUEST.
 
 menu "Virtio drivers"
+	depends on !IPIPE
 
 config VIRTIO_PCI
 	tristate "PCI driver for virtio devices"
diff --git a/drivers/watchdog/Kconfig b/drivers/watchdog/Kconfig
index fa15a683ae2d..4fdc31da7095 100644
--- a/drivers/watchdog/Kconfig
+++ b/drivers/watchdog/Kconfig
@@ -5,6 +5,7 @@
 
 menuconfig WATCHDOG
 	bool "Watchdog Timer Support"
+	depends on !IPIPE
 	---help---
 	  If you say Y here (and to one of the following options) and create a
 	  character special file /dev/watchdog with major number 10 and minor
diff --git a/fs/Kconfig.binfmt b/fs/Kconfig.binfmt
index b2f82cf6bf86..2debf2a84334 100644
--- a/fs/Kconfig.binfmt
+++ b/fs/Kconfig.binfmt
@@ -157,6 +157,7 @@ config BINFMT_EM86
 
 config BINFMT_MISC
 	tristate "Kernel support for MISC binaries"
+	depends on !IPIPE
 	---help---
 	  If you say Y here, it will be possible to plug wrapper-driven binary
 	  formats into the kernel. You will like this especially when you use
diff --git a/init/Kconfig b/init/Kconfig
index 33cca939377e..f00ecfff20fa 100644
--- a/init/Kconfig
+++ b/init/Kconfig
@@ -65,7 +65,7 @@ config CROSS_COMPILE
 
 config COMPILE_TEST
 	bool "Compile also drivers which will not load"
-	depends on !UML
+	depends on !UML && !IPIPE
 	default n
 	help
 	  Some drivers can be compiled on a different platform than they are
@@ -222,7 +222,7 @@ config DEFAULT_HOSTNAME
 
 config SWAP
 	bool "Support for paging of anonymous memory (swap)"
-	depends on MMU && BLOCK
+	depends on MMU && BLOCK && !IPIPE
 	default y
 	help
 	  This option allows you to choose whether you want to have support
@@ -298,6 +298,7 @@ config FHANDLE
 
 config USELIB
 	bool "uselib syscall"
+	depends on !IPIPE
 	def_bool ALPHA || M68K || SPARC || X86_32 || IA32_EMULATION
 	help
 	  This option enables the uselib syscall, a system call used in the
@@ -308,7 +309,7 @@ config USELIB
 
 config AUDIT
 	bool "Auditing support"
-	depends on NET
+	depends on NET && !IPIPE
 	help
 	  Enable auditing infrastructure that can be used with another
 	  kernel subsystem, such as SELinux (which requires this for
@@ -373,6 +374,7 @@ config VIRT_CPU_ACCOUNTING_GEN
 	bool "Full dynticks CPU time accounting"
 	depends on HAVE_CONTEXT_TRACKING
 	depends on HAVE_VIRT_CPU_ACCOUNTING_GEN
+	depends on !IPIPE
 	select VIRT_CPU_ACCOUNTING
 	select CONTEXT_TRACKING
 	help
@@ -392,6 +394,7 @@ endchoice
 config IRQ_TIME_ACCOUNTING
 	bool "Fine granularity task level IRQ time accounting"
 	depends on HAVE_IRQ_TIME_ACCOUNTING && !VIRT_CPU_ACCOUNTING_NATIVE
+	depends on !IPIPE
 	help
 	  Select this option to enable fine granularity task irq time
 	  accounting. This is done by reading a timestamp on each
@@ -718,6 +721,7 @@ config CGROUP_WRITEBACK
 
 menuconfig CGROUP_SCHED
 	bool "CPU controller"
+	depends on !IPIPE
 	default n
 	help
 	  This feature lets CPU scheduler recognize task groups and control CPU
@@ -809,7 +813,7 @@ config CGROUP_HUGETLB
 
 config CPUSETS
 	bool "Cpuset controller"
-	depends on SMP
+	depends on SMP && !IPIPE
 	help
 	  This option will let you create and manage CPUSETs which
 	  allow dynamically partitioning a system into sets of CPUs and
@@ -837,7 +841,7 @@ config CGROUP_CPUACCT
 
 config CGROUP_PERF
 	bool "Perf controller"
-	depends on PERF_EVENTS
+	depends on PERF_EVENTS && !IPIPE
 	help
 	  This option extends the perf per-cpu mode to restrict monitoring
 	  to threads which belong to the cgroup specified and run on the
@@ -861,7 +865,7 @@ config CGROUP_BPF
 config CGROUP_DEBUG
 	bool "Debug controller"
 	default n
-	depends on DEBUG_KERNEL
+	depends on DEBUG_KERNEL && !IPIPE
 	help
 	  This option enables a simple controller that exports
 	  debugging information about the cgroups framework. This
@@ -949,6 +953,7 @@ endif # NAMESPACES
 
 config SCHED_AUTOGROUP
 	bool "Automatic process group scheduling"
+	depends on !IPIPE
 	select CGROUPS
 	select CGROUP_SCHED
 	select FAIR_GROUP_SCHED
@@ -1044,6 +1049,7 @@ config CC_OPTIMIZE_FOR_PERFORMANCE
 
 config CC_OPTIMIZE_FOR_SIZE
 	bool "Optimize for size"
+	depends on !IPIPE
 	help
 	  Enabling this option will pass "-Os" instead of "-O2" to
 	  your compiler resulting in a smaller kernel.
@@ -1174,16 +1180,16 @@ config POSIX_TIMERS
 	  If unsure say y.
 
 config KALLSYMS
-	 bool "Load all symbols for debugging/ksymoops" if EXPERT
-	 default y
-	 help
+	bool "Load all symbols for debugging/ksymoops" if EXPERT
+	default y
+	help
 	   Say Y here to let the kernel print out symbolic crash information and
 	   symbolic stack backtraces. This increases the size of the kernel
 	   somewhat, as all symbols have to be loaded into the kernel image.
 
 config KALLSYMS_ALL
 	bool "Include all symbols in kallsyms"
-	depends on DEBUG_KERNEL && KALLSYMS
+	depends on DEBUG_KERNEL && KALLSYMS && !IPIPE
 	help
 	   Normally kallsyms only contains the symbols of functions for nicer
 	   OOPS messages and backtraces (i.e., symbols from the text and inittext
@@ -1504,7 +1510,7 @@ config VM_EVENT_COUNTERS
 config SLUB_DEBUG
 	default y
 	bool "Enable SLUB debugging support" if EXPERT
-	depends on SLUB && SYSFS
+	depends on SLUB && SYSFS && !IPIPE
 	help
 	  SLUB has extensive debug support features. Disabling these can
 	  result in significant savings in code size. This also disables
@@ -1514,7 +1520,7 @@ config SLUB_DEBUG
 config SLUB_MEMCG_SYSFS_ON
 	default n
 	bool "Enable memcg SLUB sysfs support by default" if EXPERT
-	depends on SLUB && SYSFS && MEMCG
+	depends on SLUB && SYSFS && MEMCG && !IPIPE
 	help
 	  SLUB creates a directory under /sys/kernel/slab for each
 	  allocation cache to host info and debug files. If memory
@@ -1606,7 +1612,7 @@ config SLAB_FREELIST_HARDENED
 
 config SLUB_CPU_PARTIAL
 	default y
-	depends on SLUB && SMP
+	depends on SLUB && SMP && !IPIPE
 	bool "SLUB per cpu partial cache"
 	help
 	  Per cpu partial caches accellerate objects allocation and freeing
@@ -1741,6 +1747,7 @@ config MODULE_FORCE_UNLOAD
 
 config MODVERSIONS
 	bool "Module versioning support"
+	depends on !IPIPE
 	help
 	  Usually, you have to use modules compiled with your kernel.
 	  Saying Y here makes it sometimes possible to use modules
@@ -1766,7 +1773,7 @@ config MODULE_SRCVERSION_ALL
 
 config MODULE_SIG
 	bool "Module signature verification"
-	depends on MODULES
+	depends on MODULES && !IPIPE
 	select SYSTEM_DATA_VERIFICATION
 	help
 	  Check modules for valid signatures upon load: the signature
@@ -1881,7 +1888,7 @@ endchoice
 
 config TRIM_UNUSED_KSYMS
 	bool "Trim unused exported kernel symbols"
-	depends on MODULES && !UNUSED_SYMBOLS
+	depends on MODULES && !UNUSED_SYMBOLS && !IPIPE
 	help
 	  The kernel and some modules make many symbols available for
 	  other modules to use via EXPORT_SYMBOL() and variants. Depending
diff --git a/kernel/ipipe/Kconfig b/kernel/ipipe/Kconfig
index d17edb89f1f5..0477694547e5 100644
--- a/kernel/ipipe/Kconfig
+++ b/kernel/ipipe/Kconfig
@@ -6,7 +6,17 @@ config HAVE_IPIPE_SUPPORT
 config IPIPE
 	bool "Interrupt pipeline"
 	depends on HAVE_IPIPE_SUPPORT
-	default n
+	default y
+	select BUG
+	select PRINTK
+	select KALLSYMS
+	select PANIC_ON_OOPS
+	select DEBUG_BUGVERBOSE
+	select PROC_FS
+	select SCHED_OMIT_FRAME_POINTER
+	select HIGH_RES_TIMERS
+	select X86_IO_APIC
+	select X86_FAST_FEATURE_TESTS if EMBEDDED
 	---help---
 	  Activate this option if you want the interrupt pipeline to be
 	  compiled in.
diff --git a/kernel/irq/Kconfig b/kernel/irq/Kconfig
index a117adf7084b..ea84542fcc6f 100644
--- a/kernel/irq/Kconfig
+++ b/kernel/irq/Kconfig
@@ -99,7 +99,7 @@ config IRQ_TIMINGS
 
 config IRQ_DOMAIN_DEBUG
 	bool "Expose hardware/virtual IRQ mapping via debugfs"
-	depends on IRQ_DOMAIN && DEBUG_FS
+	depends on IRQ_DOMAIN && DEBUG_FS && !IPIPE
 	help
 	  This option will show the mapping relationship between hardware irq
 	  numbers and Linux irq numbers. The mapping is exposed via debugfs
@@ -126,7 +126,7 @@ config SPARSE_IRQ
 
 config GENERIC_IRQ_DEBUGFS
 	bool "Expose irq internals in debugfs"
-	depends on DEBUG_FS
+	depends on DEBUG_FS && !IPIPE
 	default n
 	---help---
 
diff --git a/kernel/power/Kconfig b/kernel/power/Kconfig
index dd2b5a4d89a5..00007dd41191 100644
--- a/kernel/power/Kconfig
+++ b/kernel/power/Kconfig
@@ -1,6 +1,6 @@
 config SUSPEND
 	bool "Suspend to RAM and standby"
-	depends on ARCH_SUSPEND_POSSIBLE
+	depends on ARCH_SUSPEND_POSSIBLE && !IPIPE
 	default y
 	---help---
 	  Allow the system to enter sleep states in which main memory is
@@ -29,11 +29,12 @@ config SUSPEND_SKIP_SYNC
 	  user-space before invoking suspend.  Say Y if that's your case.
 
 config HIBERNATE_CALLBACKS
+	depends on !IPIPE
 	bool
 
 config HIBERNATION
 	bool "Hibernation (aka 'suspend to disk')"
-	depends on SWAP && ARCH_HIBERNATION_POSSIBLE
+	depends on SWAP && ARCH_HIBERNATION_POSSIBLE && !IPIPE
 	select HIBERNATE_CALLBACKS
 	select LZO_COMPRESS
 	select LZO_DECOMPRESS
@@ -143,6 +144,7 @@ config PM_WAKELOCKS_GC
 
 config PM
 	bool "Device power management core functionality"
+	depends on !IPIPE
 	---help---
 	  Enable functionality allowing I/O devices to be put into energy-saving
 	  (low power) states, for example after a specified period of inactivity
diff --git a/kernel/rcu/Kconfig.debug b/kernel/rcu/Kconfig.debug
index 2034d02e8ee3..bd33c2767fe2 100644
--- a/kernel/rcu/Kconfig.debug
+++ b/kernel/rcu/Kconfig.debug
@@ -13,7 +13,7 @@ config TORTURE_TEST
 
 config RCU_PERF_TEST
 	tristate "performance tests for RCU"
-	depends on DEBUG_KERNEL
+	depends on DEBUG_KERNEL && !IPIPE
 	select TORTURE_TEST
 	select SRCU
 	select TASKS_RCU
@@ -30,7 +30,7 @@ config RCU_PERF_TEST
 
 config RCU_TORTURE_TEST
 	tristate "torture tests for RCU"
-	depends on DEBUG_KERNEL
+	depends on DEBUG_KERNEL && !IPIPE
 	select TORTURE_TEST
 	select SRCU
 	select TASKS_RCU
@@ -58,7 +58,7 @@ config RCU_CPU_STALL_TIMEOUT
 
 config RCU_TRACE
 	bool "Enable tracing for RCU"
-	depends on DEBUG_KERNEL
+	depends on DEBUG_KERNEL && !IPIPE
 	default y if TREE_RCU
 	select TRACE_CLOCK
 	help
@@ -70,7 +70,7 @@ config RCU_TRACE
 
 config RCU_EQS_DEBUG
 	bool "Provide debugging asserts for adding NO_HZ support to an arch"
-	depends on DEBUG_KERNEL
+	depends on DEBUG_KERNEL && !IPIPE
 	help
 	  This option provides consistency checks in RCU's handling of
 	  NO_HZ.  These checks have proven quite helpful in detecting
diff --git a/kernel/trace/Kconfig b/kernel/trace/Kconfig
index 5f93356dd495..5af0e1637403 100644
--- a/kernel/trace/Kconfig
+++ b/kernel/trace/Kconfig
@@ -122,7 +122,8 @@ if TRACING_SUPPORT
 
 menuconfig FTRACE
 	bool "Tracers"
-	default y if DEBUG_KERNEL
+	depends on !IPIPE || IPIPE_TRACE
+	default n if DEBUG_KERNEL
 	help
 	  Enable the kernel tracing infrastructure.
 
diff --git a/lib/Kconfig.debug b/lib/Kconfig.debug
index 8a84a77bde1a..8a86c801a9e1 100644
--- a/lib/Kconfig.debug
+++ b/lib/Kconfig.debug
@@ -47,7 +47,7 @@ config MESSAGE_LOGLEVEL_DEFAULT
 
 config BOOT_PRINTK_DELAY
 	bool "Delay each boot printk message by N milliseconds"
-	depends on DEBUG_KERNEL && PRINTK && GENERIC_CALIBRATE_DELAY
+	depends on DEBUG_KERNEL && PRINTK && GENERIC_CALIBRATE_DELAY && !IPIPE
 	help
 	  This build option allows you to read kernel boot messages
 	  by inserting a short delay after each one.  The delay is
@@ -68,6 +68,7 @@ config DYNAMIC_DEBUG
 	default n
 	depends on PRINTK
 	depends on DEBUG_FS
+	depends on !IPIPE
 	help
 
 	  Compiles debug level messages into the kernel, which would not
@@ -139,7 +140,7 @@ menu "Compile-time checks and compiler options"
 
 config DEBUG_INFO
 	bool "Compile the kernel with debug info"
-	depends on DEBUG_KERNEL && !COMPILE_TEST
+	depends on DEBUG_KERNEL && !COMPILE_TEST && !IPIPE
 	help
           If you say Y here the resulting kernel image will include
 	  debugging info resulting in a larger kernel image.
@@ -230,7 +231,7 @@ config FRAME_WARN
 
 config STRIP_ASM_SYMS
 	bool "Strip assembler-generated symbols during link"
-	default n
+	default y
 	help
 	  Strip internal assembler-generated symbols during a link (symbols
 	  that look like '.Lxxx') so they don't pollute the output of
@@ -238,7 +239,7 @@ config STRIP_ASM_SYMS
 
 config READABLE_ASM
         bool "Generate readable assembler code"
-        depends on DEBUG_KERNEL
+        depends on DEBUG_KERNEL && !IPIPE
         help
           Disable some compiler optimizations that tend to generate human unreadable
           assembler output. This may make the kernel slightly slower, but it helps
@@ -247,7 +248,8 @@ config READABLE_ASM
 
 config UNUSED_SYMBOLS
 	bool "Enable unused/obsolete exported symbols"
-	default y if X86
+	depends on !IPIPE
+	default n if X86
 	help
 	  Unused but exported symbols make the kernel needlessly bigger.  For
 	  that reason most of these unused exports will soon be removed.  This
@@ -263,7 +265,7 @@ config UNUSED_SYMBOLS
 
 config PAGE_OWNER
 	bool "Track page owner"
-	depends on DEBUG_KERNEL && STACKTRACE_SUPPORT
+	depends on DEBUG_KERNEL && STACKTRACE_SUPPORT && !IPIPE
 	select DEBUG_FS
 	select STACKTRACE
 	select STACKDEPOT
@@ -307,6 +309,7 @@ config HEADERS_CHECK
 
 config DEBUG_SECTION_MISMATCH
 	bool "Enable full Section mismatch analysis"
+	depends on !IPIPE
 	help
 	  The section mismatch analysis checks if there are illegal
 	  references from one section to another section.
@@ -360,6 +363,7 @@ config FRAME_POINTER
 		(CRIS || M68K || FRV || UML || \
 		 SUPERH || BLACKFIN || MN10300 || METAG) || \
 		ARCH_WANT_FRAME_POINTERS
+	depends on !IPIPE
 	default y if (DEBUG_INFO && UML) || ARCH_WANT_FRAME_POINTERS
 	help
 	  If you say Y here the resulting kernel image will be slightly
@@ -368,7 +372,7 @@ config FRAME_POINTER
 
 config STACK_VALIDATION
 	bool "Compile-time stack metadata validation"
-	depends on HAVE_STACK_VALIDATION
+	depends on HAVE_STACK_VALIDATION && !IPIPE
 	default n
 	help
 	  Add compile-time checks to validate stack metadata, including frame
@@ -383,7 +387,7 @@ config STACK_VALIDATION
 
 config DEBUG_FORCE_WEAK_PER_CPU
 	bool "Force weak per-cpu definitions"
-	depends on DEBUG_KERNEL
+	depends on DEBUG_KERNEL && !IPIPE
 	help
 	  s390 and alpha require percpu variables in modules to be
 	  defined weak to work around addressing range issue which
@@ -446,7 +450,7 @@ source mm/Kconfig.debug
 
 config DEBUG_OBJECTS
 	bool "Debug object operations"
-	depends on DEBUG_KERNEL
+	depends on DEBUG_KERNEL && !IPIPE
 	help
 	  If you say Y here, additional code will be inserted into the
 	  kernel to track the life time of various objects and validate
@@ -507,7 +511,7 @@ config DEBUG_OBJECTS_ENABLE_DEFAULT
 
 config DEBUG_SLAB
 	bool "Debug slab memory allocations"
-	depends on DEBUG_KERNEL && SLAB
+	depends on DEBUG_KERNEL && SLAB && !IPIPE
 	help
 	  Say Y here to have the kernel do limited verification on memory
 	  allocation as well as poisoning memory on free to catch use of freed
@@ -533,7 +537,7 @@ config SLUB_DEBUG_ON
 config SLUB_STATS
 	default n
 	bool "Enable SLUB performance statistics"
-	depends on SLUB && SYSFS
+	depends on SLUB && SYSFS && !IPIPE
 	help
 	  SLUB statistics are useful to debug SLUBs allocation behavior in
 	  order find ways to optimize the allocator. This should never be
@@ -548,7 +552,7 @@ config HAVE_DEBUG_KMEMLEAK
 
 config DEBUG_KMEMLEAK
 	bool "Kernel memory leak detector"
-	depends on DEBUG_KERNEL && HAVE_DEBUG_KMEMLEAK
+	depends on DEBUG_KERNEL && HAVE_DEBUG_KMEMLEAK && !IPIPE
 	select DEBUG_FS
 	select STACKTRACE if STACKTRACE_SUPPORT
 	select KALLSYMS
@@ -598,7 +602,7 @@ config DEBUG_KMEMLEAK_DEFAULT_OFF
 
 config DEBUG_STACK_USAGE
 	bool "Stack utilization instrumentation"
-	depends on DEBUG_KERNEL && !IA64
+	depends on DEBUG_KERNEL && !IA64 && !IPIPE
 	help
 	  Enables the display of the minimum amount of free stack which each
 	  task has ever had available in the sysrq-T and sysrq-P debug output.
@@ -607,7 +611,7 @@ config DEBUG_STACK_USAGE
 
 config DEBUG_VM
 	bool "Debug VM"
-	depends on DEBUG_KERNEL
+	depends on DEBUG_KERNEL && !IPIPE
 	help
 	  Enable this to turn on extended checks in the virtual-memory system
           that may impact performance.
@@ -645,7 +649,7 @@ config ARCH_HAS_DEBUG_VIRTUAL
 
 config DEBUG_VIRTUAL
 	bool "Debug VM translations"
-	depends on DEBUG_KERNEL && ARCH_HAS_DEBUG_VIRTUAL
+	depends on DEBUG_KERNEL && ARCH_HAS_DEBUG_VIRTUAL && !IPIPE
 	help
 	  Enable some costly sanity checks in virtual to page code. This can
 	  catch mistakes with virt_to_page() and friends.
@@ -698,6 +702,7 @@ config DEBUG_PER_CPU_MAPS
 	bool "Debug access to per_cpu maps"
 	depends on DEBUG_KERNEL
 	depends on SMP
+	depends on !IPIPE
 	help
 	  Say Y to verify that the per_cpu map being accessed has
 	  been set up. This adds a fair amount of code to kernel memory
@@ -707,7 +712,7 @@ config DEBUG_PER_CPU_MAPS
 
 config DEBUG_HIGHMEM
 	bool "Highmem debugging"
-	depends on DEBUG_KERNEL && HIGHMEM
+	depends on DEBUG_KERNEL && HIGHMEM && !IPIPE
 	help
 	  This option enables additional error checking for high memory
 	  systems.  Disable for production systems.
@@ -746,7 +751,7 @@ config ARCH_HAS_KCOV
 
 config KCOV
 	bool "Code coverage for fuzzing"
-	depends on ARCH_HAS_KCOV
+	depends on ARCH_HAS_KCOV && !IPIPE
 	select DEBUG_FS
 	select GCC_PLUGINS if !COMPILE_TEST
 	select GCC_PLUGIN_SANCOV if !COMPILE_TEST
@@ -780,7 +785,15 @@ config DEBUG_SHIRQ
 	  Drivers ought to be able to handle interrupts coming in at those
 	  points; some don't and need to be caught.
 
+#
+# Enables a timestamp based low pass filter to compensate for perf based
+# hard lockup detection which runs too fast due to turbo modes.
+#
+config HARDLOCKUP_CHECK_TIMESTAMP
+	bool
+
 menu "Debug Lockups and Hangs"
+	depends on !IPIPE
 
 config LOCKUP_DETECTOR
 	bool
@@ -802,13 +815,6 @@ config HARDLOCKUP_DETECTOR_PERF
 	bool
 	select SOFTLOCKUP_DETECTOR
 
-#
-# Enables a timestamp based low pass filter to compensate for perf based
-# hard lockup detection which runs too fast due to turbo modes.
-#
-config HARDLOCKUP_CHECK_TIMESTAMP
-	bool
-
 #
 # arch/ can define HAVE_HARDLOCKUP_DETECTOR_ARCH to provide their own hard
 # lockup detector rather than the perf based detector.
@@ -968,7 +974,7 @@ config PANIC_TIMEOUT
 
 config SCHED_DEBUG
 	bool "Collect scheduler debugging info"
-	depends on DEBUG_KERNEL && PROC_FS
+	depends on DEBUG_KERNEL && PROC_FS && !IPIPE
 	default y
 	help
 	  If you say Y here, the /proc/sched_debug file will be provided
@@ -981,7 +987,7 @@ config SCHED_INFO
 
 config SCHEDSTATS
 	bool "Collect scheduler statistics"
-	depends on DEBUG_KERNEL && PROC_FS
+	depends on DEBUG_KERNEL && PROC_FS && !IPIPE
 	select SCHED_INFO
 	help
 	  If you say Y here, additional code will be inserted into the
@@ -994,7 +1000,7 @@ config SCHEDSTATS
 
 config SCHED_STACK_END_CHECK
 	bool "Detect stack corruption on calls to schedule()"
-	depends on DEBUG_KERNEL
+	depends on DEBUG_KERNEL && !IPIPE
 	default n
 	help
 	  This option checks for a stack overrun on calls to schedule().
@@ -1006,6 +1012,7 @@ config SCHED_STACK_END_CHECK
 
 config DEBUG_TIMEKEEPING
 	bool "Enable extra timekeeping sanity checking"
+	depends on !IPIPE
 	help
 	  This option will enable additional timekeeping sanity checks
 	  which may be helpful when diagnosing issues where timekeeping
@@ -1019,7 +1026,7 @@ config DEBUG_TIMEKEEPING
 
 config DEBUG_PREEMPT
 	bool "Debug preemptible kernel"
-	depends on DEBUG_KERNEL && PREEMPT && TRACE_IRQFLAGS_SUPPORT
+	depends on DEBUG_KERNEL && PREEMPT && TRACE_IRQFLAGS_SUPPORT && !IPIPE
 	default y
 	help
 	  If you say Y here then the kernel will use a debug variant of the
@@ -1028,6 +1035,7 @@ config DEBUG_PREEMPT
 	  will detect preemption count underflows.
 
 menu "Lock Debugging (spinlocks, mutexes, etc...)"
+	depends on !IPIPE
 
 config DEBUG_RT_MUTEXES
 	bool "RT Mutex debugging, deadlock detection"
@@ -1038,7 +1046,7 @@ config DEBUG_RT_MUTEXES
 
 config DEBUG_SPINLOCK
 	bool "Spinlock and rw-lock debugging: basic checks"
-	depends on DEBUG_KERNEL
+	depends on DEBUG_KERNEL && !IPIPE
 	select UNINLINE_SPIN_UNLOCK
 	help
 	  Say Y here and build SMP to catch missing spinlock initialization
@@ -1283,7 +1291,7 @@ config WARN_ALL_UNSEEDED_RANDOM
 
 config DEBUG_KOBJECT
 	bool "kobject debugging"
-	depends on DEBUG_KERNEL
+	depends on DEBUG_KERNEL && !IPIPE
 	help
 	  If you say Y here, some extra kobject debugging messages will be sent
 	  to the syslog. 
@@ -1330,7 +1338,7 @@ config DEBUG_LIST
 
 config DEBUG_PI_LIST
 	bool "Debug priority linked list manipulation"
-	depends on DEBUG_KERNEL
+	depends on DEBUG_KERNEL && !IPIPE
 	help
 	  Enable this to turn on extended checks in the priority-ordered
 	  linked-list (plist) walking routines.  This checks the entire
@@ -1340,7 +1348,7 @@ config DEBUG_PI_LIST
 
 config DEBUG_SG
 	bool "Debug SG table operations"
-	depends on DEBUG_KERNEL
+	depends on DEBUG_KERNEL && !IPIPE
 	help
 	  Enable this to turn on checks on scatter-gather tables. This can
 	  help find problems with drivers that do not properly initialize
@@ -1350,7 +1358,7 @@ config DEBUG_SG
 
 config DEBUG_NOTIFIERS
 	bool "Debug notifier call chains"
-	depends on DEBUG_KERNEL
+	depends on DEBUG_KERNEL && !IPIPE
 	help
 	  Enable this to turn on sanity checking for notifier call chains.
 	  This is most useful for kernel developers to make sure that
@@ -1360,7 +1368,7 @@ config DEBUG_NOTIFIERS
 
 config DEBUG_CREDENTIALS
 	bool "Debug credential management"
-	depends on DEBUG_KERNEL
+	depends on DEBUG_KERNEL && !IPIPE
 	help
 	  Enable this to turn on some debug checking for credential
 	  management.  The additional code keeps track of the number of
@@ -1377,7 +1385,7 @@ source "kernel/rcu/Kconfig.debug"
 
 config DEBUG_WQ_FORCE_RR_CPU
 	bool "Force round-robin CPU selection for unbound work items"
-	depends on DEBUG_KERNEL
+	depends on DEBUG_KERNEL && !IPIPE
 	default n
 	help
 	  Workqueue used to implicitly guarantee that work items queued
@@ -1392,8 +1400,7 @@ config DEBUG_WQ_FORCE_RR_CPU
 
 config DEBUG_BLOCK_EXT_DEVT
         bool "Force extended block device numbers and spread them"
-	depends on DEBUG_KERNEL
-	depends on BLOCK
+	depends on DEBUG_KERNEL && BLOCK && !IPIPE
 	default n
 	help
 	  BIG FAT WARNING: ENABLING THIS OPTION MIGHT BREAK BOOTING ON
@@ -1432,7 +1439,7 @@ config CPU_HOTPLUG_STATE_CONTROL
 
 config NOTIFIER_ERROR_INJECTION
 	tristate "Notifier error injection"
-	depends on DEBUG_KERNEL
+	depends on DEBUG_KERNEL && !IPIPE
 	select DEBUG_FS
 	help
 	  This option provides the ability to inject artificial errors to
@@ -1507,7 +1514,7 @@ config NETDEV_NOTIFIER_ERROR_INJECT
 
 config FAULT_INJECTION
 	bool "Fault-injection framework"
-	depends on DEBUG_KERNEL
+	depends on DEBUG_KERNEL && !IPIPE
 	help
 	  Provide fault-injection framework.
 	  For more details, see Documentation/fault-injection/.
@@ -1576,9 +1583,7 @@ config FAULT_INJECTION_STACKTRACE_FILTER
 
 config LATENCYTOP
 	bool "Latency measuring infrastructure"
-	depends on DEBUG_KERNEL
-	depends on STACKTRACE_SUPPORT
-	depends on PROC_FS
+	depends on DEBUG_KERNEL && STACKTRACE_SUPPORT && PROC_FS && !IPIPE
 	select FRAME_POINTER if !MIPS && !PPC && !S390 && !MICROBLAZE && !ARM_UNWIND && !ARC && !X86
 	select KALLSYMS
 	select KALLSYMS_ALL
@@ -1593,7 +1598,7 @@ source kernel/trace/Kconfig
 
 config PROVIDE_OHCI1394_DMA_INIT
 	bool "Remote debugging over FireWire early on boot"
-	depends on PCI && X86
+	depends on PCI && X86 && !IPIPE
 	help
 	  If you want to debug problems which hang or crash the kernel early
 	  on boot and the crashing machine has a FireWire port, you can use
@@ -1622,7 +1627,7 @@ config PROVIDE_OHCI1394_DMA_INIT
 
 config DMA_API_DEBUG
 	bool "Enable debugging of DMA-API usage"
-	depends on HAVE_DMA_API_DEBUG
+	depends on HAVE_DMA_API_DEBUG && !IPIPE
 	help
 	  Enable this option to debug the use of the DMA API by device drivers.
 	  With this option you will be able to detect common bugs in device
@@ -1640,11 +1645,11 @@ config DMA_API_DEBUG
 	  If unsure, say N.
 
 menu "Runtime Testing"
+	depends on !IPIPE
 
 config LKDTM
 	tristate "Linux Kernel Dump Test Tool Module"
-	depends on DEBUG_FS
-	depends on BLOCK
+	depends on DEBUG_FS && BLOCK
 	default n
 	help
 	This module enables testing of the different dumping mechanisms by
@@ -1677,8 +1682,7 @@ config TEST_SORT
 
 config KPROBES_SANITY_TEST
 	bool "Kprobes sanity tests"
-	depends on DEBUG_KERNEL
-	depends on KPROBES
+	depends on DEBUG_KERNEL && KPROBES
 	default n
 	help
 	  This option provides for testing basic kprobes functionality on
@@ -1923,7 +1927,7 @@ endmenu # runtime tests
 
 config MEMTEST
 	bool "Memtest"
-	depends on HAVE_MEMBLOCK
+	depends on HAVE_MEMBLOCK && !IPIPE
 	---help---
 	  This option adds a kernel parameter 'memtest', which allows memtest
 	  to be set.
diff --git a/lib/Kconfig.kasan b/lib/Kconfig.kasan
index 3d35d062970d..507adf6d287b 100644
--- a/lib/Kconfig.kasan
+++ b/lib/Kconfig.kasan
@@ -6,6 +6,7 @@ if HAVE_ARCH_KASAN
 config KASAN
 	bool "KASan: runtime memory debugger"
 	depends on SLUB || (SLAB && !DEBUG_SLAB)
+	depends on !IPIPE
 	select CONSTRUCTORS
 	select STACKDEPOT
 	help
diff --git a/lib/Kconfig.kgdb b/lib/Kconfig.kgdb
index ab4ff0eea776..b12066b1a691 100644
--- a/lib/Kconfig.kgdb
+++ b/lib/Kconfig.kgdb
@@ -5,7 +5,7 @@ config HAVE_ARCH_KGDB
 menuconfig KGDB
 	bool "KGDB: kernel debugger"
 	depends on HAVE_ARCH_KGDB
-	depends on DEBUG_KERNEL
+	depends on DEBUG_KERNEL && !IPIPE
 	help
 	  If you say Y here, it will be possible to remotely debug the
 	  kernel using gdb.  It is recommended but not required, that
diff --git a/lib/Kconfig.ubsan b/lib/Kconfig.ubsan
index a669c193b878..17a668f8aefd 100644
--- a/lib/Kconfig.ubsan
+++ b/lib/Kconfig.ubsan
@@ -6,6 +6,7 @@ config ARCH_WANTS_UBSAN_NO_NULL
 
 config UBSAN
 	bool "Undefined behaviour sanity checker"
+	depends on !IPIPE
 	help
 	  This option enables undefined behaviour sanity checker
 	  Compile-time instrumentation is used to detect various undefined
diff --git a/lib/xz/Kconfig b/lib/xz/Kconfig
index 12d2d777f36b..06552fb30990 100644
--- a/lib/xz/Kconfig
+++ b/lib/xz/Kconfig
@@ -16,26 +16,31 @@ config XZ_DEC_X86
 config XZ_DEC_POWERPC
 	bool "PowerPC BCJ filter decoder" if EXPERT
 	default y
+	depends on PPC
 	select XZ_DEC_BCJ
 
 config XZ_DEC_IA64
 	bool "IA-64 BCJ filter decoder" if EXPERT
 	default y
+	depends on IA64
 	select XZ_DEC_BCJ
 
 config XZ_DEC_ARM
 	bool "ARM BCJ filter decoder" if EXPERT
 	default y
+	depends on ARM
 	select XZ_DEC_BCJ
 
 config XZ_DEC_ARMTHUMB
 	bool "ARM-Thumb BCJ filter decoder" if EXPERT
 	default y
+	depends on ARM_THUMB || ARM_THUMBEE
 	select XZ_DEC_BCJ
 
 config XZ_DEC_SPARC
 	bool "SPARC BCJ filter decoder" if EXPERT
 	default y
+	depends on SPARC
 	select XZ_DEC_BCJ
 
 endif
diff --git a/mm/Kconfig b/mm/Kconfig
index cc4d633947bf..6b281b40d774 100644
--- a/mm/Kconfig
+++ b/mm/Kconfig
@@ -160,7 +160,7 @@ config HAVE_BOOTMEM_INFO_NODE
 config MEMORY_HOTPLUG
 	bool "Allow for memory hot-add"
 	depends on SPARSEMEM || X86_64_ACPI_NUMA
-	depends on ARCH_ENABLE_MEMORY_HOTPLUG
+	depends on ARCH_ENABLE_MEMORY_HOTPLUG && !IPIPE
 
 config MEMORY_HOTPLUG_SPARSE
 	def_bool y
@@ -753,6 +753,7 @@ config ARCH_HAS_PKEYS
 config PERCPU_STATS
 	bool "Collect percpu memory statistics"
 	default n
+	depends on !IPIPE
 	help
 	  This feature collects and exposes statistics via debugfs. The
 	  information includes global and per chunk statistics, which can
diff --git a/mm/Kconfig.debug b/mm/Kconfig.debug
index e5e606ee5f71..1368ae779904 100644
--- a/mm/Kconfig.debug
+++ b/mm/Kconfig.debug
@@ -1,5 +1,6 @@
 config PAGE_EXTENSION
 	bool "Extend memmap on extra space for more information on page"
+	depends on !IPIPE
 	---help---
 	  Extend memmap on extra space for more information on page. This
 	  could be used for debugging features that need to insert extra
@@ -9,7 +10,7 @@ config PAGE_EXTENSION
 
 config DEBUG_PAGEALLOC
 	bool "Debug page memory allocations"
-	depends on DEBUG_KERNEL
+	depends on DEBUG_KERNEL && !IPIPE
 	depends on !HIBERNATION || ARCH_SUPPORTS_DEBUG_PAGEALLOC && !PPC && !SPARC
 	select PAGE_EXTENSION
 	select PAGE_POISONING if !ARCH_SUPPORTS_DEBUG_PAGEALLOC
@@ -41,6 +42,7 @@ config DEBUG_PAGEALLOC_ENABLE_DEFAULT
 
 config PAGE_POISONING
 	bool "Poison pages after freeing"
+	depends on !IPIPE
 	select PAGE_POISONING_NO_SANITY if HIBERNATION
 	---help---
 	  Fill the pages with poison patterns after free_pages() and verify
@@ -79,7 +81,7 @@ config PAGE_POISONING_ZERO
 
 config DEBUG_PAGE_REF
 	bool "Enable tracepoint to track down page reference manipulation"
-	depends on DEBUG_KERNEL
+	depends on DEBUG_KERNEL && !IPIPE
 	depends on TRACEPOINTS
 	---help---
 	  This is a feature to add tracepoint for tracking down page reference
diff --git a/samples/Kconfig b/samples/Kconfig
index 9cb63188d3ef..4c4c6a07d15c 100644
--- a/samples/Kconfig
+++ b/samples/Kconfig
@@ -1,5 +1,6 @@
 menuconfig SAMPLES
 	bool "Sample kernel code"
+	depends on !IPIPE
 	help
 	  You can build and test sample kernel code here.
 
diff --git a/security/Kconfig b/security/Kconfig
index 87f2a6f842fd..1dd3ec658282 100644
--- a/security/Kconfig
+++ b/security/Kconfig
@@ -22,6 +22,7 @@ config SECURITY
 	bool "Enable different security models"
 	depends on SYSFS
 	depends on MULTIUSER
+	depends on !IPIPE
 	help
 	  This allows you to choose different security modules to be
 	  configured into your kernel.
@@ -38,6 +39,7 @@ config SECURITY_WRITABLE_HOOKS
 
 config SECURITYFS
 	bool "Enable the securityfs filesystem"
+	depends on !IPIPE
 	help
 	  This will build the securityfs filesystem.  It is currently used by
 	  the TPM bios character driver and IMA, an integrity provider.  It is
@@ -56,7 +58,7 @@ config SECURITY_NETWORK
 
 config PAGE_TABLE_ISOLATION
 	bool "Remove the kernel mapping in user mode"
-	depends on X86_64 && !UML
+	depends on X86_64 && !UML && !IPIPE
 	default y
 	help
 	  This feature reduces the number of hardware side channels by
@@ -152,7 +154,7 @@ config HAVE_HARDENED_USERCOPY_ALLOCATOR
 
 config HARDENED_USERCOPY
 	bool "Harden memory copies between kernel and userspace"
-	depends on HAVE_HARDENED_USERCOPY_ALLOCATOR
+	depends on HAVE_HARDENED_USERCOPY_ALLOCATOR && !IPIPE
 	select BUG
 	imply STRICT_DEVMEM
 	help
-- 
2.25.1

